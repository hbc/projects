---
output:
  html_document:
    toc: true
    toc_depth: 4
    theme: united
title: "Microarray of RIP-chip samples - exclude WT1"
bibliography: "references.bib"
---

```{r setup, echo=FALSE, warning=FALSE, message=FALSE}
library(knitcitations)
cleanbib()
options("citation_format" = "pandoc")

clientname="Valerie Schumacher "
clientemail="Valerie.Schumacher@childrens.harvard.edu"
labPI="Schumacher"
lablocation="HMS"
analystname="John Hutchinson"
analystemail="jhutchin@hsph.harvard.edu"


library(knitr)
opts_chunk$set(warning=FALSE, error=FALSE, message=FALSE, echo=FALSE, cache=TRUE, tidy.opts=list(keep.blank.line=FALSE, width.cutoff=120), dev="svg")
options(width=200)
```

---

Array analysis for `r clientname` (`r clientemail`), `r labPI` group at `r lablocation`.  

Contact `r analystname` (`r analystemail`) for additional details.

The most recent update of this html document occurred: `r date()`

The sections below provide code to reproduce the included results and plots. 

---

# Methods Summary  


---

# Setup

## Variables
Working directories, files and other variables necessary to the analysis.

```{r variables}
## Setup Data and Results directory variables
if(file.exists("/n/hsphS10/hsphfs1/chb/projects/vs_ripchip/")){
  baseDir="/n/hsphS10/hsphfs1/chb/projects/vs_ripchip/"
    } else if (file.exists("/Users/johnhutchinson/Work/projects/vs_ripchip/")){
    baseDir="/Users/johnhutchinson/Work/projects/vs_ripchip/"
    }

dataDir <- file.path(baseDir, "data")
metaDir <- file.path(baseDir, "meta")
resultsDir <- file.path(baseDir, "results")

cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7") # colorblind friendly palette
covarsfilename="covars.desc" # tab delimited file describing samples
lowintensity.percentile=0.1
mad.quantile.cutoff=0.1
pvalue.cutoff=0.05
highlight.color="green"
lfc.cutoff=log2(1.5)
# number of genes to show in heatmap
numtop=50
```

## Libraries

[Bioconductor](http://www.bioconductor.org) and [R](http://cran.r-project.org/) libraries used to process and visualize the data.

```{r libraries_variables}
library(oligo) # array utilities
library(pd.mogene.1.0.st.v1)# array layout annotation
library(mogene10sttranscriptcluster.db)
library(arrayQualityMetrics) # array quality control reports
library(limma) # array statistical analyses
library(pheatmap) # pretty heatmaps
library(plyr) # data format utility
library(reshape2) # data format utility
library(devtools) # install libraries from github
install_git("git://github.com/hbc/CHBUtils.git") # misc personal utilities
library(CHBUtils) # some homegrown functions
library(ggplot2) # pretty graphs
library(ggdendro) # for pretty dendrograms
library(RColorBrewer) # more colors
library(gridExtra) # for arranging multiple plots
library(venneuler) # for venm diagrams
library(GO.db) # database of GO terms and genes
library(biomaRt) # large biological database
library(sva)
library(magrittr)
library(lattice)
library(RRHO)
library(dplyr)
library(rio)
```

## Functions

```{r functions}
# for plotting amount of variation explained by principal components
PCAplot.sd.eset <- function(eset=NULL,  title=NULL){
  eset.core <- exprs(eset)
  myPca.core <- prcomp(t(eset.core))
  # SD of components
  sdevdf <- data.frame(cbind(as.numeric(myPca.core$sdev),c(1:length(myPca.core$sdev))))
  sdevdf$prop <-  sdevdf$X1/sum(sdevdf$X1)
  sdevdf$cum <- cumsum(sdevdf$prop)
  ggplot(sdevdf, aes(x=X2, y=prop)) + 
    geom_point(size=4, color="red") + 
    scale_x_continuous('Component') + 
    scale_y_continuous('Standard Deviation') +
    ggtitle(title) +
    geom_line(data=sdevdf, aes(x=X2, y=cum))
}

# used for formatting labels on ggplots
fmt <- function(){ 
  function(x) format(x,nsmall = 1,scientific = FALSE)
}

vcplot <- function(stats, plottitle="Volcano Plot with Marginal Distributions", pval.cutoff=0.05, lfc.cutoff=1, shade.colour="green", shade.alpha=0.25, point.colour="gray", point.alpha=0.75, point.outline.colour="darkgray", line.colour="gray", axistitlefontsize=24, axislabelfontsize=12) {
  # get range of log fold change and p-value values to setup plot borders
  range.lfc <- c(floor(min(stats$logFC)), ceiling(max(stats$logFC)))
  range.pval <- c(floor(min(-log10(stats$adj.P.Val))), ceiling(max(-log10(stats$adj.P.Val))))
  
  #make top plot - density plot with fold changes
  lfcd <- as.data.frame(cbind(density(stats$logFC)$x, density(stats$logFC)$y))
  hist_top <- ggplot(data=stats, aes(x=logFC))+
    geom_density(color=line.colour)+
    geom_ribbon(data=subset(lfcd, V1>lfc.cutoff),aes(x=V1,ymax=V2),ymin=0,fill=shade.colour, alpha=shade.alpha)+
    theme_bw()+ 
    theme(axis.title.x=element_blank())+
    theme(plot.margin=unit(c(3,-5.5,4,3), "mm") )+
    scale_x_continuous(limits = range.lfc, breaks = range.lfc[1]:range.lfc[2], expand = c(.05,.05))+
    scale_y_continuous(labels=fmt()) +
   theme(axis.text=element_text(size=axislabelfontsize), axis.title=element_text(size=axistitlefontsize))
  
  # make blank plot
  empty <- ggplot()+geom_point(aes(1,1), colour="white")+
    theme(panel.grid=element_blank(),
          panel.border=element_blank(),
          axis.ticks=element_blank(), 
          panel.background=element_blank(), 
          axis.text.x=element_blank(),  
          axis.text.y=element_blank(),          
          axis.title.x=element_blank(), 
          axis.title.y=element_blank()
    )
  
  #make scatter volcano plot
  scat.poly.up <- with(stats, data.frame(x=as.numeric(c(lfc.cutoff,  lfc.cutoff, max(range.lfc),max(range.lfc))), y=as.numeric(c(-log10(pval.cutoff), max(range.pval), max(range.pval),-log10(pval.cutoff)))))
  
  scatter <- ggplot(data=stats, aes(x=logFC, y=-log10(adj.P.Val))) +
    geom_point(alpha=point.alpha, pch=21, fill=point.colour, color=point.outline.colour) +
    geom_polygon(data=scat.poly.up, aes(x=x,y=y), fill=shade.colour, alpha=shade.alpha) +
    xlab("log2 fold change") + ylab("-log10(adjusted p-value)") +
    theme_bw()+
    theme(legend.position="none") +
    theme(plot.margin=unit(c(3,-5.5,4,3), "mm") )+
    scale_x_continuous(limits = range.lfc, breaks = range.lfc[1]:range.lfc[2], expand = c(.05,.05))+
    scale_y_continuous(labels=fmt(), limits = range.pval)+
    theme(axis.text=element_text(size=axislabelfontsize), axis.title=element_text(size=axistitlefontsize))    
  
  # make right plot - density plot of adjusted pvalues
  pvald <- as.data.frame(cbind(density(-log10(stats$adj.P.Val))$x, density(-log10(stats$adj.P.Val))$y))
  hist_right <- ggplot(data=stats, aes(x=-log10(adj.P.Val)))+
    geom_density(color=line.colour)+
    geom_ribbon(data=subset(pvald, V1>-log10(pval.cutoff)),aes(x=V1,ymax=V2),ymin=0,fill=shade.colour, alpha=shade.alpha)+
    theme_bw()+coord_flip()+
    scale_x_continuous(limits = range.pval)+
    theme(axis.title.y=element_blank())+ 
    theme(plot.margin=unit(c(3,-5.5,4,3), "mm"))+
    theme(axis.text=element_text(size=axislabelfontsize), axis.title=element_text(size=axistitlefontsize))    
  
  # plot all plots
  pp.logfc <- ggplotGrob(hist_top)
  pp.empty <- ggplotGrob(empty)
  pp.volc <- ggplotGrob(scatter)
  pp.pval  <- ggplotGrob(hist_right)
  
 grid.arrange(top=textGrob(plottitle, gp = gpar(fontsize = axistitlefontsize*1.2, fontface = 'bold'),),
               arrangeGrob(pp.logfc,
                           pp.volc, 
                           heights=c(1,3),
                           ncol=1),
               arrangeGrob(pp.empty,
                           pp.pval,  
                           heights=c(1,3),
                           ncol=1), 
               ncol=2, 
               widths=c(3,1))
} 

```

---

# Import Data and Metadata

## Data

- load in phenotypes and array names from metadata file (covars.desc) in "metadata" directory
  - this file contains the names and descriptions of CEL files contained in the data directory 
- use array names to load in arrays 

```{r dataload, results='hide'}
covars <- read.table(file.path(metaDir, covarsfilename),header=TRUE, sep="\t", row.names=1) # simple tab delimited file with CEL file in first column (no heading for this column) and sample metadata (i.e. sampleID, treatment group, batch etc.) in subsequent columns

celFiles <- file.path(dataDir, row.names(covars))
affyRaw <- read.celfiles(celFiles)
pData(affyRaw) <- covars 
sampleNames(affyRaw) <- pData(affyRaw)$sampleID
validObject(affyRaw)
rm(covars)
```

## Sample metadata

```{r covars, results='asis'}
# Sample information table
kable(pData(affyRaw))
```

---

# PreProcessing 

## Raw Data 

### Quality Control


```{r rawQC, eval=FALSE}
arrayQualityMetrics(expressionset=affyRaw, outdir=file.path(resultsDir, 'report_raw'), force=TRUE, do.logtransform=TRUE, intgroup=c("pulldown", "source", "run"))
```

[Raw Data QC Report](../results/report_raw/index.html)

The arrays look fine, no problems at all.

## RMA Normalized Data

- background correct and normalize data with RMA `r citep("10.1093/bioinformatics/19.2.185")`

- summarize probesets on the gene ('core') level

```{r normalize, results='hide'}
affyNorm.core <- rma(affyRaw, target="core", background=TRUE, normalize=TRUE)
```

### Quality Control
- using arrayQualityMetrics library

```{r normQC, eval=FALSE}
arrayQualityMetrics(expressionset=affyNorm.core, outdir=file.path(resultsDir, paste("report_rma.core", sep=".")), force=TRUE, do.logtransform=FALSE, intgroup=c("pulldown", "source", "run"))
```

[Normalized Data QC Report](../results/report_rma.core/index.html)

The arrays look good, and the clustering looks very good. 

### Unsupervised Clustering of RMA Normalized Data

#### Hierarchical Clustering
The goal of these analyses are to naiively evaluate the variability within the raw data and determine whether this variability can predict the different sample groups

The first method produces a dendrogram by performing  
>  a hierarchical cluster analysis using a set of dissimilarities for the n objects being clustered

Here, I've fist highlighted which input sample was mRNA, and then highlighted the different pulldown categories. 

```{r cluster1, out.width='100%'}
plot_dendro(affyNorm.core, title="", labels.colname="pulldown", colors.colname="source")
plot_dendro(affyNorm.core, title="", labels.colname="pulldown", colors.colname="pulldown")
```

#### Principal Component Analysis (PCA)

This second approach is a dimension reduction and visualisation technique that is used to project the multivariate (i.e.multiple genes) data vector of each array into a lower-dimensional plot, such that the spatial arrangement of the points in the plot reflects the overall data (dis)similarity between the arrays. The data is typically reduced to a small number of dimensions (or components) which explain most of the sample variability. This [Youtube slideshow](https://www.youtube.com/watch?v=BfTMmoDFXyE) gives a pretty good basic explanation of what PCA is doing.

```{r PCAsd1, out.width='75%'}
PCAplot.sd.eset(affyNorm.core, title="")
```

Here, each point depicts the amount of variation explained by each component and the line shows the cumulative amount. For this data set,  very few dimensions (3) can explain >75% of the variation observed in the samples.

As plots with more than 2 dimensions are difficult to visualize, we typically  split up the dimensions/components and plot them pairwise against each other; the plots here show scatterplots of the arrays along all dual combinations of the first three principal components. In the first plot, each sample group is represented by a separate color and in the second plot each sample is represented by a different color. 

You can use these plots to explore if the arrays cluster, find outliers, and determine whether this is according to an intended experimental factor or according to unintended causes such as batch effects. In these plots, I have once again first highlighted the RNA source (mRNA or whole RNA) and then highlighted the individual pulldown categories.

```{r pca1, out.width='100%'}
PCAplot.eset(affyNorm.core, categories="source", title="", colorpalette=cbPalette, numcomponents=3, alpha=0.75)
PCAplot.eset(affyNorm.core, categories="pulldown", title="", colorpalette=cbPalette, numcomponents=3, alpha=0.75)
```

There is  a high degree of clustering by pulldown type. So much so, that when you plot PC1 against PC2, both the input samples and stau2 samples largely overlap their respective sample groups. These results are consistent with a lower level of biological variation, likely resulting from the use of a single cell line for the experiment, making these replicates closer to technical replicates. The single input sample outlier is the mRNA sample.

These unsupervised clustering resutls reveal that the mRNA input sample has clear differences from the whole RNA input samples, more than can be attributed to batch effect, given how closely the *Stau2* pulldown whole RNA repeat sample from the same run clusters with the *Stau2* whole RNA samples from the first run.

---

## Batch Correction

The whole RNA and mRNA input RNA samples were run on different days and may show batch effects. As an identical sample was also run both days, we can try adjusting for batch using ComBat r citep("doi: 10.1093/biostatistics/kxj037") from the sva package and see if it improves the data clustering. 

```{r batchm, dev="png"}
library(sva)

# Create model with batch as factor variable
mod <- model.matrix(~as.factor(pulldown), data=pData(affyNorm.core))

modcombat <- model.matrix(~1, data=pData(affyNorm.core))

batch <- pData(affyNorm.core)$run
# Modify expression matrix
eset.core <- exprs(affyNorm.core)
combat_edata <- ComBat(dat=eset.core,
                       batch=batch,
                       mod=modcombat,
                       par.prior=TRUE, 
                       prior.plots=TRUE)
affyNorm.core.batch <- affyNorm.core
exprs(affyNorm.core.batch) <- combat_edata

PCAplot.eset(affyNorm.core.batch, categories="source", title="", colorpalette=cbPalette, numcomponents=3, alpha=0.75)
PCAplot.eset(affyNorm.core.batch, categories="pulldown", title="", colorpalette=cbPalette, numcomponents=3, alpha=0.75)
```

Based on the low variation within the Stau2 group before batch correction (look back to the first PCA plot) there does not appear to be much need for batch correction. In fact, the PCA plot after batch correction shows an undesirable loss of signal (and averaging betweeen samples), potentially due to the lack of inclusion of a repeated input sample. Given this, I decided to skip batch correction for this analysis.

Continuing forward, I removed the repeated Stau2 whole RNA sample.

```{r removerepeat}
pd <- pData(affyNorm.core)
affyNorm.core <- affyNorm.core[,!(pd$sampleID=="stau2-whole-3" & pd$run==2)]

# drop unused levels from pData as well
pData(affyNorm.core) <- as.data.frame(apply(pData(affyNorm.core), 2, function(x) factor(x)))
```

---

## Annotate

So far we have only been working with the probesets,without reference to the genes they assay. Here we load in metadata about the probesets on the array (feature data), the gene symbols in particular.

```{r features, results='hide'}
featureData(affyNorm.core) <- getNetAffx(affyNorm.core, "transcript") # this will load the Affymetrix annotation, including the probeID, into the fData
# get gene symbols and entrezIDs for all probesets
fData(affyNorm.core)$symbol <- as.character(unlist(mget(featureNames(affyNorm.core), mogene10sttranscriptclusterSYMBOL, ifnotfound=NA))) # curated annotations from Bioconductor 
fData(affyNorm.core)$entrezID <- as.character(unlist(mget(featureNames(affyNorm.core), mogene10sttranscriptclusterENTREZID, ifnotfound=NA))) # curated annotations from Bioconductor 
numprobes <- nrow(fData(affyNorm.core))
```

## Filter Probesets
Reducing the number of genes assayed reduces  the multiple test correction and may allow us to identify more differentially expressed genes.

Starting  with `r numprobes` probes remaining we can filter:

### By Annotation
- remove the control probes and probes without annotated genes

```{r filter1}
affyNorm.core <- affyNorm.core[which(!is.na(fData(affyNorm.core)$symbol) & fData(affyNorm.core)$category=="main"),]
numprobes <- nrow(fData(affyNorm.core))
```

`r numprobes` probes remaining

### By Cross Hybridization
- some probes are annotated as potentially hybridizing to multiple targets

```{r filter2}
affyNorm.core <- affyNorm.core[which(fData(affyNorm.core)$crosshybtype=="1"),]
numprobes <- nrow(fData(affyNorm.core))
```

`r numprobes` probes remaining

### By Low Expression Level
- remove probes with low expression levels (bottom `r lowintensity.percentile*100`% of all expression levels) in all samples

```{r filter3}
eset.core <- exprs(affyNorm.core)
affyNorm.core <- affyNorm.core[!(apply(eset.core, 1, function(x) all(x<quantile(exprs(affyNorm.core), 0.1)))),]
numprobes <- nrow(fData(affyNorm.core))
```

`r numprobes` probes remaining

### By Low Variability
- remove probes with lower variation among all samples (without regard for group status) (dropped the bottom `r mad.quantile.cutoff*100`%) 

```{r filter4}
eset.core <- exprs(affyNorm.core)
rowmads <- apply(eset.core, 1, mad)
mad.cutoff <- as.numeric(quantile(rowmads, mad.quantile.cutoff))
affyNorm.core <- affyNorm.core[rowmads>mad.cutoff,]
numprobes <- nrow(fData(affyNorm.core))
```

`r numprobes` probes remaining

---

# Statistical Analyses

## Limma

A linear model for microarray data analysis (Limma) was performed on the samples to identify differentially expressed genes for comparisons of the sample groups. Limma fits a linear model to the expression data for all samples for each gene and is designed to handle complex experiments involving comparisons between many RNA targets simultaneously.

To perform limma, we construct two matrices. The design matrix provides a representation of the different sample groups which have been analysed. The contrast matrix allows the coefficients defined by the design matrix to be combined into contrasts of interest.

### Design 
- make a matrix with arrays as rows, sample groups as columns
- a one or a zero indicate respectively, that a sample either belongs or does not belong to the sample group 

```{r design2, results="asis"}
design <- model.matrix(~ 0 + group,  data=pData(affyNorm.core))
# make sure the headings match
library(magrittr) # fun with pipes
colnames(design) %>% sub("group", "", .) %>% sub("-", "_", .) -> colnames(design)
kable(design)
```

### Contrasts
- to perform specified pairwise comparisons
- in this table, columns are contrasts/comparisons and rows are sample groups
-  a zero denotes that the sample group is not involved in the contrast, a 1 denotes that it has higher expression in the contrast and a -1 denotes lower expression in the contrast

I  setup four  contrasts, two to select genes that show a significant expression change between the input (both mRNA and whole RNA) and pulldown Stau2 samples and two to select genes that show a significant expression change between the input (both mRNA and whole RNA) and pulldown WT1 samples.

```{r contrastmatrix2, results='asis'}
contrast.matrix <- makeContrasts(stau2_whole=stau2_whole-input_whole, 
                                 stau2_mRNA=stau2_whole-input_mrna,
                                 wt1_whole=wt1_whole-input_whole,
                                 wt1_mRNA=wt1_whole-input_mrna,
                                 levels=colnames(design))
dimnames(contrast.matrix)$Contrasts <- gsub(" " , "", dimnames(contrast.matrix)$Contrasts)
kable(contrast.matrix)
```

These matrices are used to fit a linear model to the data. The linear model is applied and pairwise comparisons are performed to identify differentially expressed genes.

- first fit the linear model based on the design matrix for each gene based on the given series of arrays
- using the contrast matrix, compute estimated coefficients and standard errors for contrasts
- compute moderated t-statistics and log-odds of differential expression by empirical Bayes shrinkage of the standard errors towards a common value

### Linear model

- for each gene based on the given series of arrays

```{r linearmodel}
eset.core <- exprs(affyNorm.core)
fit.core <- lmFit(eset.core, design) 
```

**Compute estimated coefficients and standard errors for contrasts**

```{r contrastfit}
fit2.core <- contrasts.fit(fit.core, contrast.matrix) 
```

### Bayes shrinkage

**Compute moderated t-statistics and log-odds of differential expression**

- by empirical Bayes shrinkage of the standard errors towards a common value

```{r bayes}
fit2.core <- eBayes(fit2.core) 
```

--- 

# Results

## Statistics

- as calculated by Limma

```{r allstats}
all.results <- lapply(seq(1:length(dimnames(contrast.matrix)$Contrasts)), function(num) {
  contrast <- dimnames(contrast.matrix)$Contrasts[num]
  stats <- topTable(fit2.core, coef=num, sort.by="B",adjust.method="BH",number=nrow(fData(affyNorm.core)), genelist=fData(affyNorm.core)[,c("probesetid", "symbol", "entrezID")])
  stats$Passes.FDR.threshold  <-  as.factor(stats$adj.P.Val<pvalue.cutoff)
  eset <- exprs(affyNorm.core)
  eset  <-  eset[match(stats$probesetid, row.names(eset)),]
  stats.eset <- cbind(stats, eset)
  return(list(contrast=contrast, stats.eset=stats.eset))
  })

# output all results to files
lapply(seq(1:length(dimnames(contrast.matrix)$Contrasts)), function(num) {
  contrast <- dimnames(contrast.matrix)$Contrasts[num]
  out.stats=as.data.frame(all.results[[num]]$stats.eset)
  write.table(out.stats, file=file.path(resultsDir, paste("all.genes.stats.exprs", contrast, "xls", sep=".")),  sep ="\t",, row.names=F, col.names=T)
})
```

### Statistics and expression levels of all genes for these comparisons

*Note that for all these files, I have not summarized values for genes assayed by multiple probes (i.e. by taking the median value), so you may see multiple instances of the same gene in the results*

`r x=1`
[Stau2 whole RNA pulldown stats - all genes](../results/all.genes.stats.exprs.`r all.results[[x]]$contrast`.xls)
`r x=x+2`
[WT1 whole RNA pulldown stats - all genes](../results/all.genes.stats.exprs.`r all.results[[x]]$contrast`.xls)

**These summary tables contain the following information:**

- logFC is the log2-fold change
- the AveExpr is the average expression value accross all arrays
- the moderated t-statistic (t) is the logFC to its standard error, the P.Value is the associated p-value
- the adj.P.Value is the p-value adjusted for multiple testing (by FDR) 
- the B-value (B) is the log-odds that a gene is differentially expressed (the-higher-the-better)
- the last 8 columns contain the log-transformed normalized expression levels for these genes in each sample

## Identifying Genes Enriched by RBP pulldown

### Volcano plots

Here we can visulize the relationship between the fold changes in expression observed for the different pulldowns. Our best candidate genes will not only have a statistically significant difference in gene expression between the two sample groups (as measured adjusted pvlaue) but also a large change (as measured by the log2 fold change). We are also only interested in genes that are enriched after pulldown, not those that are higher in the input samples.

**Each of these plots contains 3 subplots:**

1) Bottom left - the volcano plot, a scatter plot with the observed log2fold changes (extremes are better) plotted against the -log10 adjusted pvalues (higher is better). For these contrasts, we are looking for genes that are enriched in the pulldown, genes that have at least an adjusted pvalue of `r pvalue.cutoff` and a log 2 fold change more than `r lfc.cutoff` are highlighted with a green box.   

2) Upper left - a density plot (smoothed histogram) of the log2 fold changes observed for the contrast, the part of the distribution above `r lfc.cutoff` is highlighted under the curve in `r highlight.color`.  

3) Lower right - a density plot (smoothed histogram) of the adjusted pvalued observed for the contrast, the part of the distribution above `r pvalue.cutoff` is highlighted under the curve in `r highlight.color`. Note that for this plot, this highlight also included genes enriched in the input samples.

```{r ggplotexps, out.width='100%', dev="svg"}
vcplot(stats=all.results[[1]]$stats.eset, plottitle="Stau2 whole RNA pulldown vs. input", lfc.cutoff = lfc.cutoff, pval.cutoff = pvalue.cutoff, shade.colour=highlight.color, axistitlefontsize = 28, axislabelfontsize = 18)          
```

Using these pvalue and log2 fold change cutoffs we can identify which genes are showing enrichment in the two pulldowns. The cutoffs I have picked here (pvalue<`r pvalue.cutoff` and log2foldchange>`r lfc.cutoff`) are within accepted range, if a bit stringent, but are arbitrary. 

**If you want to change these cutoffs to be more or less stringent, you can filter the Excel files above by adj.P.Val and logFC in Excel.**

For these cutoffs: 
`r x=1`
- the `r all.results[[x]]$contrast` contrast, has `r nrow(subset(all.results[[x]]$stats.eset, logFC>lfc.cutoff & adj.P.Val<pvalue.cutoff))` enriched probesets probing `r length(unique(subset(all.results[[x]]$stats.eset, logFC>lfc.cutoff & adj.P.Val<pvalue.cutoff)$symbol))` genes.

### Statistics and expression levels for just these differentially expressed genes

```{r ouputtop, results='hide'}
# output top results to files
lapply(seq(1:length(dimnames(contrast.matrix)$Contrasts)), function(num) {
  contrast <- dimnames(contrast.matrix)$Contrasts[num]
  out.stats=as.data.frame(subset(all.results[[num]]$stats.eset, logFC>lfc.cutoff & adj.P.Val<pvalue.cutoff))
  write.table(out.stats, file=file.path(resultsDir, paste("top.enriched.genes.stats.exprs", contrast, "xls", sep=".")),  sep ="\t",, row.names=F, col.names=T)
})
```

*Note that, once again, for all these files I have not summarized values for genes assayed by multiple probes (i.e. by taking the median value), so you may see multiple instances of the same gene in the results*

`r x=1`
[Stau2 whole RNA pulldown stats - top enriched genes](../results/top.enriched.genes.stats.exprs.`r all.results[[x]]$contrast`.xls)

*These summary tables contain the same information as the files above*

### Heatmaps of genes bound by Stau2

#### Top 50 for Stau2

```{r heatmaps2, out.width='100%', dev='png', fig.height=11, fig.width=8.5}
top.results.Stau2 <- subset(all.results[[1]]$stats.eset, logFC>lfc.cutoff & adj.P.Val<pvalue.cutoff)

# microarray intensities fwith rows labelle diwht probeset and gene
top.results.Stau2 <- top.results.Stau2 %>% tbl_df() %>% select(., -contains("wt1"))

# grab top 50 genes by logFC
eset.of.interest.Stau2 <- top.results.Stau2 %>%  
  arrange(., desc(logFC) ) %>% 
  select(.,  contains("symbol"), contains("whole"), logFC) %>%
  .[1:numtop,]
names(eset.of.interest.Stau2) <- gsub("_whole", "", names(eset.of.interest.Stau2))
# cluster with hclust and reorder matrix
eset.of.interest.Stau2 <- select(eset.of.interest.Stau2, -logFC, -symbol) %>% 
  as.matrix(.) %>% 
  dist(., method="euclidean") %>% 
  hclust(., method="centroid") %>%
  .$order %>%
  eset.of.interest.Stau2[.,]


# annotations
pd <- pData(affyNorm.core) %>% tbl_df()

heatmap.annots <- pd %>% filter(., source=="whole_RNA", pulldown!="Wt1") %>% mutate(., sampleID=sub("_whole", "", sampleID)) %>% select(., sampleID, pulldown)
heatmap.annots <- as.data.frame(heatmap.annots)
heatmap.annots <- col2rownames(heatmap.annots, "sampleID")

# annotation colors
pulldown_colors <- c(cbPalette[1:2] )
names(pulldown_colors) <- unique(unlist(heatmap.annots$pulldown))
ann_colors = list(pulldown = pulldown_colors)
## Heatmaps

pheatmap(as.matrix(select(eset.of.interest.Stau2, -symbol, -logFC)),
         annotation=heatmap.annots, 
         color = colorRampPalette(rev(brewer.pal(n = 11, name = "RdBu")))(100),
         #color=rev(brewer.pal(11,"RdBu")), 
         cluster_cols = FALSE, 
         cluster_rows = FALSE,
         main="Genes enriched after pulldown with Stau2", 
         fontsize=12,
         fontsize_row=14,
         annotation_colors=ann_colors,
         show_colnames=TRUE, 
         show_rownames=TRUE,
         labels_row = eset.of.interest.Stau2$symbol,
                 cellwidth=40, annotation_names_col = FALSE)
```

## Gene Ontologies

### TOP 200

```{r functional1, fig.align='center', dev='png'}
top200.Stau2 <- arrange(top.results.Stau2 , desc(logFC)) %>% select(., symbol) %>% as.data.frame() %>% unlist(.) %>% as.vector(.) %>% .[1:200]
#top200.Stau2 <- filter(top.results.Stau2, logFC>=1) %>% select(., symbol) %>% as.data.frame() %>% unlist(.) %>% as.vector(.)
library(gProfileR)
background <- all.results[[1]]$stats.eset %>% tbl_df() %>% dplyr::select(., symbol) %>% as.data.frame() %>% unlist(.) %>% as.vector(.)

 gprofiler_results  <-     gprofiler(query = top200.Stau2, 
            organism = "mmusculus",
            ordered_query = T, 
            exclude_iea = F, 
            max_p_value = 0.05, 
            max_set_size = 0,
            correction_method = "gSCS",
            hier_filtering = "none", 
            domain_size = "annotated") 
 
 
gprofiler_results <- tbl_df(gprofiler_results ) %>% mutate(., domain_size=22029) %>% mutate(., enrichment=(overlap.size/query.size)/(term.size/domain_size))
renal_go <- gprofiler_results 
write.csv(gprofiler_results, file.path(resultsDir, "GOresults.top200.csv"))
``` 

Running the top 200 genes (as sorted by logFC)  through [g:profiler](http://biit.cs.ut.ee/gprofiler/) reveals significant enrichment of genes involved in cytoskeletal protein binding.   
**[File with GO results](../results/GOresults.top200.csv)**

```{r gosummaries, dev='png',   fig.width=9,fig.height=2}
library(GOsummaries)
bp1 <- gosummaries(list(`Biological Process`=top200.Stau2), organism = "mmusculus", ordered_query = TRUE, go_branches = "BP")
plot(bp1, panel_height=0, wordcloud_colors=c( "#41B6C4", "#081D58"))

cc1 <- gosummaries(list(`Cellular Component`=top200.Stau2), organism = "mmusculus", ordered_query = TRUE, go_branches = "CC")
plot(cc1, panel_height=0, wordcloud_colors=c( "#41B6C4", "#081D58"))
mf1 <- gosummaries(list(`Molecular Function`=top200.Stau2), organism = "mmusculus", ordered_query = TRUE, go_branches = "MF")
plot(mf1, panel_height=0, wordcloud_colors=c( "#41B6C4", "#081D58"))
```

Gene ontology enrichment analyses can yield an overwhelming number of enriched categories, many with redundant functionality. We can simplify this output by identifying the most representative subset of the terms, using metrics which measure the semantic similarity of the terms. [Revigo](http://revigo.irb.hr/) `r citep("10.1371/journal.pone.0021800")` performs such analyses, using an algortithm which forms

>  groups of highly similar GO terms, where the choice of the groupsâ€™ representatives is guided by the p-values

The algorithm takes into account the parent-child structure of the gene onotology database

> If the p-values are quite close and one term is a child node of the other, REVIGO will tend to choose the parent term

The algorithm also tries to find more specific GO terms.

> Very general GO terms, however, are always avoided as cluster representatives ... as they tend to be uninformative

Revigo allows visualization of these representatives and their relations to the terms within their group  as a [treemap](http://en.wikipedia.org/wiki/Treemapping). Here the color depicts a grouping of related terms, the size of a block, it's pvalue from g:profiler and the large text the most representative gene ontology term for the related group.


```{r revigo, dev='png'}
# A treemap R script produced by the REVIGO server at http://revigo.irb.hr/
# If you found REVIGO useful in your work, please cite the following reference:
# Supek F et al. "REVIGO summarizes and visualizes long lists of Gene Ontology
# terms" PLoS ONE 2011. doi:10.1371/journal.pone.0021800

# author: Anton Kratz <anton.kratz@gmail.com>, RIKEN Omics Science Center, Functional Genomics Technology Team, Japan
# created: Fri, Nov 02, 2012  7:25:52 PM
# last change: Fri, Nov 09, 2012  3:20:01 PM

# -----------------------------------------------------------------------------
# If you don't have the treemap package installed, uncomment the following line:
# install.packages( "treemap" );
library(treemap) 								# treemap package by Martijn Tennekes

# Set the working directory if necessary
# setwd("C:/Users/username/workingdir");

# --------------------------------------------------------------------------
# Here is your data from REVIGO. Scroll down for plot configuration options.

bp.pval.revigo.names  <- c("term_ID","description","freqInDbPercent","abslog10pvalue","uniqueness","dispensability","representative");
bp.pval.revigo.data <- rbind(c("GO:0006996","organelle organization",0.932,9.8386,0.724,0.000,"organelle organization"),
c("GO:0007098","centrosome cycle",0.005,4.4425,0.574,0.620,"organelle organization"),
c("GO:0033044","regulation of chromosome organization",0.022,1.8962,0.591,0.686,"organelle organization"),
c("GO:1902589","single-organism organelle organization",0.635,9.3915,0.618,0.619,"organelle organization"),
c("GO:0009987","cellular process",65.994,5.2472,0.993,0.000,"cellular process"),
c("GO:0032502","developmental process",1.387,1.5331,0.981,0.000,"developmental process"),
c("GO:0044699","single-organism process",53.975,5.7545,0.991,0.000,"single-organism process"),
c("GO:0051641","cellular localization",1.638,2.3556,0.973,0.000,"cellular localization"),
c("GO:0051303","establishment of chromosome localization",0.002,1.4023,0.962,0.188,"cellular localization"),
c("GO:0065007","biological regulation",14.918,6.2907,0.983,0.000,"biological regulation"),
c("GO:0071840","cellular component organization or biogenesis",5.425,8.5498,0.981,0.000,"cellular component organization or biogenesis"),
c("GO:1901360","organic cyclic compound metabolic process",33.913,1.3615,0.912,0.000,"organic cyclic compound metabolism"),
c("GO:0022402","cell cycle process",0.527,7.6536,0.715,0.028,"cell cycle process"),
c("GO:0006302","double-strand break repair",0.063,3.1871,0.758,0.680,"cell cycle process"),
c("GO:0090304","nucleic acid metabolic process",20.158,3.1255,0.739,0.388,"cell cycle process"),
c("GO:0000278","mitotic cell cycle",0.087,2.6478,0.744,0.684,"cell cycle process"),
c("GO:0006310","DNA recombination",1.840,4.0496,0.771,0.652,"cell cycle process"),
c("GO:0051716","cellular response to stimulus",6.259,1.6904,0.856,0.695,"cell cycle process"),
c("GO:0018130","heterocycle biosynthetic process",16.150,1.6055,0.783,0.493,"cell cycle process"),
c("GO:0018205","peptidyl-lysine modification",0.061,2.1186,0.804,0.158,"cell cycle process"),
c("GO:0006281","DNA repair",1.953,6.4112,0.674,0.110,"cell cycle process"),
c("GO:0000075","cell cycle checkpoint",0.020,4.9208,0.757,0.611,"cell cycle process"),
c("GO:0044763","single-organism cellular process",41.995,5.7799,0.877,0.118,"cell cycle process"),
c("GO:0035556","intracellular signal transduction",2.718,1.6402,0.641,0.689,"cell cycle process"),
c("GO:0007346","regulation of mitotic cell cycle",0.034,3.0799,0.633,0.635,"cell cycle process"),
c("GO:0044260","cellular macromolecule metabolic process",28.588,2.3363,0.769,0.525,"cell cycle process"),
c("GO:0007049","cell cycle",1.410,5.0200,0.886,0.123,"cell cycle process"),
c("GO:0051301","cell division",1.357,2.0057,0.886,0.122,"cell cycle process"),
c("GO:0051304","chromosome separation",0.039,2.2495,0.732,0.641,"cell cycle process"),
c("GO:0018022","peptidyl-lysine methylation",0.003,2.2097,0.810,0.541,"cell cycle process"),
c("GO:0046483","heterocycle metabolic process",33.326,1.5935,0.865,0.259,"cell cycle process"),
c("GO:0006139","nucleobase-containing compound metabolic process",29.917,1.9586,0.775,0.528,"cell cycle process"),
c("GO:1903046","meiotic cell cycle process",0.015,3.6091,0.733,0.599,"cell cycle process"),
c("GO:0019438","aromatic compound biosynthetic process",15.562,1.9706,0.784,0.466,"cell cycle process"),
c("GO:1901362","organic cyclic compound biosynthetic process",16.583,1.6402,0.818,0.421,"cell cycle process"),
c("GO:0006725","cellular aromatic compound metabolic process",33.051,1.8539,0.865,0.143,"cell cycle process"),
c("GO:0000725","recombinational repair",0.042,3.0942,0.765,0.656,"cell cycle process"),
c("GO:0006259","DNA metabolic process",6.339,5.6055,0.752,0.382,"cell cycle process"),
c("GO:0006464","cellular protein modification process",2.895,1.4353,0.739,0.628,"cell cycle process"),
c("GO:0000724","double-strand break repair via homologous recombination",0.041,3.0942,0.765,0.656,"cell cycle process"),
c("GO:0034654","nucleobase-containing compound biosynthetic process",13.019,1.8013,0.749,0.465,"cell cycle process"),
c("GO:0034645","cellular macromolecule biosynthetic process",17.200,1.5436,0.715,0.507,"cell cycle process"),
c("GO:0048523","negative regulation of cellular process",0.942,1.6162,0.744,0.030,"negative regulation of cellular process"),
c("GO:0048519","negative regulation of biological process",1.243,1.7100,0.798,0.365,"negative regulation of cellular process"),
c("GO:0048518","positive regulation of biological process",0.684,1.3019,0.810,0.343,"negative regulation of cellular process"),
c("GO:0050789","regulation of biological process",14.473,5.7799,0.727,0.512,"negative regulation of cellular process"),
c("GO:0007275","multicellular organismal development",0.460,2.4647,0.911,0.053,"multicellular organismal development"),
c("GO:0007017","microtubule-based process",0.172,4.4855,0.902,0.087,"microtubule-based process"),
c("GO:0007059","chromosome segregation",0.373,4.8729,0.897,0.093,"chromosome segregation"));

bp.pval.stuff <- data.frame(bp.pval.revigo.data);
names(bp.pval.stuff) <- bp.pval.revigo.names;

bp.pval.stuff$abslog10pvalue <- as.numeric( as.character(bp.pval.stuff$abslog10pvalue) );
bp.pval.stuff$freqInDbPercent <- as.numeric( as.character(bp.pval.stuff$freqInDbPercent) );
bp.pval.stuff$uniqueness <- as.numeric( as.character(bp.pval.stuff$uniqueness) );
bp.pval.stuff$dispensability <- as.numeric( as.character(bp.pval.stuff$dispensability) );

treemap(
	bp.pval.stuff,
	index = c("representative","description"),
	vSize = "abslog10pvalue",
	type = "categorical",
	vColor = "representative",
	title = "REVIGO Biological Process Gene Ontology treemap - pvalue based",
	inflate.labels = FALSE,      # set this to TRUE for space-filling group labels - good for posters
	lowerbound.cex.labels = 0,   # try to draw as many labels as possible (still, some small squares may not get a label)
	bg.labels = "#CCCCCC00",     # define background color of group labels
												       # "#CCCCCC00" is fully transparent, "#CCCCCCAA" is semi-transparent grey, NA is opaque
	position.legend = "none",
  border.col=c("black","gray35"),
  palette.HCL.options=list(hue_start=80, hue_perm=TRUE),
  border.lwds=c(5,2),
  fontsize.labels=c(36,12),
  fontcolor.labels=c("black", "gray34"),
  fontsize.title=14
  )

################################################################################################################
################################################################################################################

################################################################################################################
################################################################################################################

cc.pval.revigo.names <-  c("term_ID","description","freqInDbPercent","abslog10pvalue","uniqueness","dispensability","representative");
cc.pval.revigo.data <- rbind(c("GO:0005623","cell",64.133,7.5017,0.981,0.000,"cell"),
c("GO:0005856","cytoskeleton",0.714,10.3979,0.510,0.000,"cytoskeleton"),
c("GO:0060053","neurofilament cytoskeleton",0.000,1.9031,0.642,0.564,"cytoskeleton"),
c("GO:0044464","cell part",64.133,7.5406,0.875,0.262,"cytoskeleton"),
c("GO:0044449","contractile fiber part",0.027,2.9788,0.442,0.360,"cytoskeleton"),
c("GO:0005694","chromosome",0.973,2.2299,0.498,0.495,"cytoskeleton"),
c("GO:0005634","nucleus",2.809,8.8268,0.500,0.365,"cytoskeleton"),
c("GO:0044446","intracellular organelle part",5.949,8.6402,0.400,0.640,"cytoskeleton"),
c("GO:0043292","contractile fiber",0.030,2.6615,0.603,0.363,"cytoskeleton"),
c("GO:0031981","nuclear lumen",0.437,7.5100,0.442,0.491,"cytoskeleton"),
c("GO:0005622","intracellular",46.136,11.5186,0.875,0.199,"cytoskeleton"),
c("GO:0043228","non-membrane-bounded organelle",8.439,10.0737,0.509,0.493,"cytoskeleton"),
c("GO:0044430","cytoskeletal part",0.579,6.2941,0.425,0.502,"cytoskeleton"),
c("GO:0044428","nuclear part",0.645,5.9706,0.474,0.663,"cytoskeleton"),
c("GO:0043232","intracellular non-membrane-bounded organelle",7.682,10.0737,0.409,0.629,"cytoskeleton"),
c("GO:0005737","cytoplasm",38.159,3.9666,0.757,0.465,"cytoskeleton"),
c("GO:0044424","intracellular part",43.664,11.3098,0.770,0.144,"cytoskeleton"),
c("GO:0043229","intracellular organelle",15.790,8.3575,0.444,0.690,"cytoskeleton"),
c("GO:0044422","organelle part",6.517,9.4157,0.521,0.573,"cytoskeleton"),
c("GO:0014704","intercalated disc",0.006,4.2993,0.911,0.000,"intercalated disc"),
c("GO:0030054","cell junction",0.154,2.6162,0.948,0.000,"cell junction"),
c("GO:0031974","membrane-enclosed lumen",0.517,5.8633,0.948,0.000,"membrane-enclosed lumen"),
c("GO:0032991","macromolecular complex",14.462,1.5214,0.955,0.000,"macromolecular complex"),
c("GO:0043226","organelle",16.716,7.9469,0.957,0.000,"organelle"),
c("GO:0043234","protein complex",8.273,3.3261,0.952,0.000,"protein complex"),
c("GO:0042995","cell projection",1.485,1.4660,0.899,0.035,"cell projection"));

cc.pval.stuff <- data.frame(cc.pval.revigo.data);
names(cc.pval.stuff) <- cc.pval.revigo.names;

cc.pval.stuff$abslog10pvalue <- as.numeric( as.character(cc.pval.stuff$abslog10pvalue) );
cc.pval.stuff$freqInDbPercent <- as.numeric( as.character(cc.pval.stuff$freqInDbPercent) );
cc.pval.stuff$uniqueness <- as.numeric( as.character(cc.pval.stuff$uniqueness) );
cc.pval.stuff$dispensability <- as.numeric( as.character(cc.pval.stuff$dispensability) );

# check the tmPlot command documentation for all possible parameters - there are a lot more
treemap(
  cc.pval.stuff,
	index = c("representative","description"),
	vSize = "abslog10pvalue",
	type = "categorical",
	vColor = "representative",
	title = "REVIGO Cellular Component Gene Ontology treemap - pvalue based",
	inflate.labels = FALSE,      # set this to TRUE for space-filling group labels - good for posters
	lowerbound.cex.labels = 0,   # try to draw as many labels as possible (still, some small squares may not get a label)
	bg.labels = "#CCCCCC00",     # define background color of group labels
	# "#CCCCCC00" is fully transparent, "#CCCCCCAA" is semi-transparent grey, NA is opaque
	position.legend = "none",
	border.col=c("black","gray35"),
	palette.HCL.options=list(hue_start=80, hue_perm=TRUE),
	border.lwds=c(5,2),
	fontsize.labels=c(36,12),
	fontcolor.labels=c("black", "gray34"),
  fontsize.title=14
)

################################################################################################################
################################################################################################################

################################################################################################################
################################################################################################################

mf.pval.revigo.names <-  c("term_ID","description","freqInDbPercent","abslog10pvalue","uniqueness","dispensability","representative");
mf.pval.revigo.data <- rbind(c("GO:0004677","DNA-dependent protein kinase activity",0.001,3.4510,0.921,0.000,"DNA-dependent protein kinase activity"),
c("GO:0042054","histone methyltransferase activity",0.016,2.4012,0.860,0.621,"DNA-dependent protein kinase activity"),
c("GO:0042800","histone methyltransferase activity (H3-K4 specific)",0.001,3.3686,0.853,0.101,"DNA-dependent protein kinase activity"),
c("GO:0005488","binding",55.585,4.7399,0.975,0.000,"binding"),
c("GO:0008047","enzyme activator activity",0.115,1.8633,0.944,0.000,"enzyme activator activity"),
c("GO:0008092","cytoskeletal protein binding",0.162,4.6904,0.717,0.000,"cytoskeletal protein binding"),
c("GO:0015631","tubulin binding",0.066,2.6676,0.712,0.524,"cytoskeletal protein binding"),
c("GO:0032403","protein complex binding",0.146,1.8013,0.719,0.556,"cytoskeletal protein binding"),
c("GO:0019899","enzyme binding",0.221,1.7852,0.712,0.575,"cytoskeletal protein binding"),
c("GO:0019901","protein kinase binding",0.053,1.6402,0.718,0.516,"cytoskeletal protein binding"),
c("GO:0003774","motor activity",0.216,2.6696,0.837,0.013,"motor activity"),
c("GO:0016817","hydrolase activity, acting on acid anhydrides",7.557,2.1805,0.854,0.274,"motor activity"),
c("GO:0017111","nucleoside-triphosphatase activity",7.074,2.5622,0.793,0.548,"motor activity"),
c("GO:0005515","protein binding",2.482,3.8794,0.837,0.052,"protein binding"),
c("GO:0003677","DNA binding",13.924,7.1169,0.727,0.092,"DNA binding"),
c("GO:0017076","purine nucleotide binding",15.986,1.3335,0.540,0.686,"DNA binding"),
c("GO:0003676","nucleic acid binding",21.746,4.0711,0.706,0.282,"DNA binding"),
c("GO:0035639","purine ribonucleoside triphosphate binding",15.477,1.6073,0.595,0.660,"DNA binding"),
c("GO:0005524","ATP binding",13.885,3.2588,0.485,0.250,"DNA binding"),
c("GO:0043168","anion binding",20.956,1.6108,0.761,0.415,"DNA binding"),
c("GO:0043167","ion binding",33.309,3.2700,0.772,0.267,"DNA binding"),
c("GO:0097159","organic cyclic compound binding",42.443,3.2457,0.762,0.304,"DNA binding"),
c("GO:1901363","heterocyclic compound binding",42.435,3.4976,0.762,0.184,"DNA binding"));
  
  
  
mf.pval.stuff <- data.frame(mf.pval.revigo.data);
names(mf.pval.stuff) <- mf.pval.revigo.names;

mf.pval.stuff$abslog10pvalue <- as.numeric( as.character(mf.pval.stuff$abslog10pvalue) );
mf.pval.stuff$freqInDbPercent <- as.numeric( as.character(mf.pval.stuff$freqInDbPercent) );
mf.pval.stuff$uniqueness <- as.numeric( as.character(mf.pval.stuff$uniqueness) );
mf.pval.stuff$dispensability <- as.numeric( as.character(mf.pval.stuff$dispensability) );

# check the tmPlot command documentation for all possible parameters - there are a lot more
treemap(
  mf.pval.stuff,
  index = c("representative","description"),
	vSize = "abslog10pvalue",
	type = "categorical",
	vColor = "representative",
	title = "REVIGO Molecular Function Gene Ontology treemap - pvalue based",
	inflate.labels = FALSE,      # set this to TRUE for space-filling group labels - good for posters
	lowerbound.cex.labels = 0,   # try to draw as many labels as possible (still, some small squares may not get a label)
	bg.labels = "#CCCCCC00",     # define background color of group labels
	# "#CCCCCC00" is fully transparent, "#CCCCCCAA" is semi-transparent grey, NA is opaque
	position.legend = "none",
	border.col=c("black","gray35"),
	palette.HCL.options=list(hue_start=80, hue_perm=TRUE),
	border.lwds=c(5,2),
	fontsize.labels=c(36,12),
	fontcolor.labels=c("black", "gray34"),
  fontsize.title=14
)
```


### More than 2 fold change

```{r functional2, fig.align='center', dev='png'}
top.Stau2 <- filter(top.results.Stau2 , logFC>1) %>% select(., symbol) %>% as.data.frame() %>% unlist(.) %>% as.vector(.) 
#top.Stau2 <- filter(top.results.Stau2, logFC>=1) %>% select(., symbol) %>% as.data.frame() %>% unlist(.) %>% as.vector(.)
library(gProfileR)
background <- all.results[[1]]$stats.eset %>% tbl_df() %>% dplyr::select(., symbol) %>% as.data.frame() %>% unlist(.) %>% as.vector(.)

 gprofiler_results  <-     gprofiler(query = top.Stau2, 
            organism = "mmusculus",
            ordered_query = T, 
            exclude_iea = F, 
            max_p_value = 0.05, 
            max_set_size = 0,
            correction_method = "gSCS",
            hier_filtering = "none", 
            domain_size = "annotated") 
 
  
gprofiler_results <- tbl_df(gprofiler_results ) %>% mutate(., domain_size=22029) %>% mutate(., enrichment=(overlap.size/query.size)/(term.size/domain_size))
 
write.csv(gprofiler_results, file.path(resultsDir, "GOresults.morethan2fc.csv"))
``` 

Running the genes with at least a two-fold expression change (logFC>=1) through [g:profiler](http://biit.cs.ut.ee/gprofiler/) reveals significant enrichment of genes involved in cytoskeletal protein binding.   
**[File with GO results](../results/GOresults.morethan2fc.csv)**

```{r gosummaries2, dev='png',  fig.width=9,fig.height=2 }
library(GOsummaries)
bp1 <- gosummaries(list(`Biological Process`=top.Stau2), organism = "mmusculus", ordered_query = TRUE, go_branches = "BP")
plot(bp1, panel_height=0, wordcloud_colors=c( "#41B6C4", "#081D58"))
cc1 <- gosummaries(list(`Cellular Component`=top.Stau2), organism = "mmusculus", ordered_query = TRUE, go_branches = "CC")
plot(cc1, panel_height=0, wordcloud_colors=c( "#41B6C4", "#081D58"))
mf1 <- gosummaries(list(`Molecular Function`=top.Stau2), organism = "mmusculus", ordered_query = TRUE, go_branches = "MF")
plot(mf1, panel_height=0, wordcloud_colors=c( "#41B6C4", "#081D58"))
```


```{r revigo2, dev='png'}
# A treemap R script produced by the REVIGO server at http://revigo.irb.hr/
# If you found REVIGO useful in your work, please cite the following reference:
# Supek F et al. "REVIGO summarizes and visualizes long lists of Gene Ontology
# terms" PLoS ONE 2011. doi:10.1371/journal.pone.0021800

# author: Anton Kratz <anton.kratz@gmail.com>, RIKEN Omics Science Center, Functional Genomics Technology Team, Japan
# created: Fri, Nov 02, 2012  7:25:52 PM
# last change: Fri, Nov 09, 2012  3:20:01 PM

# -----------------------------------------------------------------------------
# If you don't have the treemap package installed, uncomment the following line:
# install.packages( "treemap" );
library(treemap) 								# treemap package by Martijn Tennekes

# Set the working directory if necessary
# setwd("C:/Users/username/workingdir");

# --------------------------------------------------------------------------
# Here is your data from REVIGO. Scroll down for plot configuration options.

bp.pval.revigo.names  <- c("term_ID","description","freqInDbPercent","abslog10pvalue","uniqueness","dispensability","representative");
bp.pval.revigo.data <-rbind(c("GO:0006996","organelle organization",0.932,24.9318,0.794,0.000,"organelle organization"),
c("GO:1902589","single-organism organelle organization",0.635,21.1707,0.706,0.619,"organelle organization"),
c("GO:0010639","negative regulation of organelle organization",0.027,3.1238,0.610,0.699,"organelle organization"),
c("GO:0044087","regulation of cellular component biogenesis",0.127,1.7328,0.682,0.486,"organelle organization"),
c("GO:0030030","cell projection organization",0.378,2.1884,0.773,0.588,"organelle organization"),
c("GO:0008152","metabolic process",82.183,4.7620,0.998,0.000,"metabolism"),
c("GO:0009987","cellular process",65.994,5.6144,0.997,0.000,"cellular process"),
c("GO:0032259","methylation",2.781,1.9706,0.985,0.000,"methylation"),
c("GO:0032502","developmental process",1.387,4.5901,0.992,0.000,"developmental process"),
c("GO:0044699","single-organism process",53.975,3.7747,0.996,0.000,"single-organism process"),
c("GO:0048518","positive regulation of biological process",0.684,11.5346,0.765,0.000,"positive regulation of biological process"),
c("GO:0048523","negative regulation of cellular process",0.942,3.9586,0.696,0.343,"positive regulation of biological process"),
c("GO:0048519","negative regulation of biological process",1.243,3.7670,0.752,0.365,"positive regulation of biological process"),
c("GO:0051235","maintenance of location",0.029,2.4123,0.804,0.247,"positive regulation of biological process"),
c("GO:0010646","regulation of cell communication",0.380,2.8268,0.712,0.313,"positive regulation of biological process"),
c("GO:0051302","regulation of cell division",0.069,6.6778,0.736,0.270,"positive regulation of biological process"),
c("GO:0019222","regulation of metabolic process",10.173,10.6383,0.686,0.549,"positive regulation of biological process"),
c("GO:0043547","positive regulation of GTPase activity",0.130,8.6459,0.677,0.332,"positive regulation of biological process"),
c("GO:0065009","regulation of molecular function",0.835,4.3686,0.765,0.331,"positive regulation of biological process"),
c("GO:0065008","regulation of biological quality",2.709,1.6904,0.737,0.405,"positive regulation of biological process"),
c("GO:0009893","positive regulation of metabolic process",0.326,8.7305,0.699,0.309,"positive regulation of biological process"),
c("GO:0097193","intrinsic apoptotic signaling pathway",0.015,1.3820,0.741,0.417,"positive regulation of biological process"),
c("GO:0033160","positive regulation of protein import into nucleus, translocation",0.000,2.1255,0.758,0.550,"positive regulation of biological process"),
c("GO:0051641","cellular localization",1.638,5.7852,0.967,0.000,"cellular localization"),
c("GO:0008104","protein localization",1.716,2.3686,0.960,0.346,"cellular localization"),
c("GO:0033036","macromolecule localization",1.969,1.6904,0.967,0.354,"cellular localization"),
c("GO:0030705","cytoskeleton-dependent intracellular transport",0.009,2.7721,0.926,0.596,"cellular localization"),
c("GO:0051649","establishment of localization in cell",1.489,3.9031,0.943,0.340,"cellular localization"),
c("GO:0065007","biological regulation",14.918,6.4260,0.993,0.000,"biological regulation"),
c("GO:0071840","cellular component organization or biogenesis",5.425,18.9957,0.992,0.000,"cellular component organization or biogenesis"),
c("GO:0007049","cell cycle",1.410,12.5129,0.903,0.032,"cell cycle"),
c("GO:0000278","mitotic cell cycle",0.087,3.8697,0.810,0.684,"cell cycle"),
c("GO:0044770","cell cycle phase transition",0.030,1.6326,0.803,0.676,"cell cycle"),
c("GO:0016310","phosphorylation",6.300,2.6478,0.918,0.147,"cell cycle"),
c("GO:0044763","single-organism cellular process",41.995,5.2534,0.898,0.111,"cell cycle"),
c("GO:0051298","centrosome duplication",0.004,4.8962,0.665,0.548,"cell cycle"),
c("GO:0051301","cell division",1.357,6.7545,0.903,0.118,"cell cycle"),
c("GO:0051321","meiotic cell cycle",0.023,4.2848,0.803,0.618,"cell cycle"),
c("GO:0046483","heterocycle metabolic process",33.326,2.9431,0.907,0.259,"cell cycle"),
c("GO:0010564","regulation of cell cycle process",0.066,7.5017,0.641,0.668,"cell cycle"),
c("GO:0006725","cellular aromatic compound metabolic process",33.051,3.5901,0.907,0.143,"cell cycle"),
c("GO:0098534","centriole assembly",0.002,1.5391,0.769,0.609,"cell cycle"),
c("GO:0000075","cell cycle checkpoint",0.020,2.3125,0.814,0.611,"cell cycle"),
c("GO:0007059","chromosome segregation",0.373,3.4089,0.913,0.102,"cell cycle"),
c("GO:0022402","cell cycle process",0.527,13.6696,0.787,0.106,"cell cycle"),
c("GO:0006928","cellular component movement",0.492,2.4609,0.911,0.105,"cell cycle"),
c("GO:0006974","cellular response to DNA damage stimulus",1.978,11.7399,0.859,0.035,"cellular response to DNA damage stimulus"),
c("GO:0006302","double-strand break repair",0.063,5.0585,0.788,0.650,"cellular response to DNA damage stimulus"),
c("GO:0023051","regulation of signaling",0.379,1.8962,0.736,0.539,"cellular response to DNA damage stimulus"),
c("GO:0010212","response to ionizing radiation",0.010,2.5406,0.939,0.338,"cellular response to DNA damage stimulus"),
c("GO:0048583","regulation of response to stimulus",0.690,1.9747,0.727,0.498,"cellular response to DNA damage stimulus"),
c("GO:0035556","intracellular signal transduction",2.718,11.3925,0.618,0.690,"cellular response to DNA damage stimulus"),
c("GO:0007264","small GTPase mediated signal transduction",0.234,5.1555,0.688,0.521,"cellular response to DNA damage stimulus"),
c("GO:0051056","regulation of small GTPase mediated signal transduction",0.112,4.1675,0.685,0.546,"cellular response to DNA damage stimulus"),
c("GO:0006950","response to stress",4.119,2.0074,0.907,0.623,"cellular response to DNA damage stimulus"),
c("GO:0000725","recombinational repair",0.042,2.4572,0.794,0.627,"cellular response to DNA damage stimulus"),
c("GO:0000724","double-strand break repair via homologous recombination",0.041,2.5003,0.794,0.627,"cellular response to DNA damage stimulus"),
c("GO:0006310","DNA recombination",1.840,5.8539,0.833,0.036,"DNA recombination"),
c("GO:0018205","peptidyl-lysine modification",0.061,3.7190,0.842,0.628,"DNA recombination"),
c("GO:0044260","cellular macromolecule metabolic process",28.588,3.6737,0.831,0.525,"DNA recombination"),
c("GO:0009059","macromolecule biosynthetic process",17.669,2.3893,0.852,0.506,"DNA recombination"),
c("GO:0006351","transcription, DNA-templated",9.014,2.7696,0.777,0.685,"DNA recombination"),
c("GO:0006139","nucleobase-containing compound metabolic process",29.917,3.6055,0.847,0.528,"DNA recombination"),
c("GO:0019438","aromatic compound biosynthetic process",15.562,1.7986,0.852,0.502,"DNA recombination"),
c("GO:0006259","DNA metabolic process",6.339,7.7545,0.822,0.379,"DNA recombination"),
c("GO:0006260","DNA replication",1.998,2.7423,0.815,0.653,"DNA recombination"),
c("GO:0090304","nucleic acid metabolic process",20.158,5.6383,0.813,0.388,"DNA recombination"),
c("GO:0010452","histone H3-K36 methylation",0.001,2.0716,0.703,0.573,"DNA recombination"),
c("GO:0018130","heterocycle biosynthetic process",16.150,1.3152,0.852,0.507,"DNA recombination"),
c("GO:0018105","peptidyl-serine phosphorylation",0.011,1.4881,0.854,0.543,"DNA recombination"),
c("GO:0043412","macromolecule modification",5.091,3.3665,0.900,0.215,"DNA recombination"),
c("GO:0051052","regulation of DNA metabolic process",0.156,3.0070,0.694,0.494,"DNA recombination"),
c("GO:0018022","peptidyl-lysine methylation",0.003,4.3188,0.845,0.124,"DNA recombination"),
c("GO:1901362","organic cyclic compound biosynthetic process",16.583,1.3063,0.879,0.497,"DNA recombination"),
c("GO:0034641","cellular nitrogen compound metabolic process",33.428,1.3872,0.877,0.432,"DNA recombination"),
c("GO:0006464","cellular protein modification process",2.895,3.8665,0.793,0.493,"DNA recombination"),
c("GO:0034645","cellular macromolecule biosynthetic process",17.200,2.6440,0.795,0.446,"DNA recombination"),
c("GO:0048731","system development",0.354,6.8539,0.770,0.057,"system development"),
c("GO:0003012","muscle system process",0.020,1.6882,0.842,0.685,"system development"),
c("GO:0061061","muscle structure development",0.035,1.3468,0.851,0.639,"system development"),
c("GO:0007569","cell aging",0.006,1.4711,0.842,0.551,"system development"),
c("GO:0048858","cell projection morphogenesis",0.049,1.3170,0.705,0.654,"system development"),
c("GO:0060322","head development",0.004,4.2848,0.867,0.555,"system development"),
c("GO:0030048","actin filament-based movement",0.005,1.3080,0.928,0.071,"actin filament-based movement"),
c("GO:0030029","actin filament-based process",0.077,1.4012,0.921,0.088,"actin filament-based process"),
c("GO:0007017","microtubule-based process",0.172,8.6819,0.917,0.095,"microtubule-based process"),
c("GO:1901360","organic cyclic compound metabolic process",33.913,2.7595,0.941,0.100,"organic cyclic compound metabolism"),
c("GO:0043170","macromolecule metabolic process",32.799,2.2495,0.941,0.230,"organic cyclic compound metabolism"));

bp.pval.stuff <- data.frame(bp.pval.revigo.data);
names(bp.pval.stuff) <- bp.pval.revigo.names;

bp.pval.stuff$abslog10pvalue <- as.numeric( as.character(bp.pval.stuff$abslog10pvalue) );
bp.pval.stuff$freqInDbPercent <- as.numeric( as.character(bp.pval.stuff$freqInDbPercent) );
bp.pval.stuff$uniqueness <- as.numeric( as.character(bp.pval.stuff$uniqueness) );
bp.pval.stuff$dispensability <- as.numeric( as.character(bp.pval.stuff$dispensability) );

treemap(
	bp.pval.stuff,
	index = c("representative","description"),
	vSize = "abslog10pvalue",
	type = "categorical",
	vColor = "representative",
	title = "REVIGO Biological Process Gene Ontology treemap - pvalue based",
	inflate.labels = FALSE,      # set this to TRUE for space-filling group labels - good for posters
	lowerbound.cex.labels = 0,   # try to draw as many labels as possible (still, some small squares may not get a label)
	bg.labels = "#CCCCCC00",     # define background color of group labels
												       # "#CCCCCC00" is fully transparent, "#CCCCCCAA" is semi-transparent grey, NA is opaque
	position.legend = "none",
  border.col=c("black","gray35"),
  palette.HCL.options=list(hue_start=80, hue_perm=TRUE),
  border.lwds=c(5,2),
  fontsize.labels=c(36,12),
  fontcolor.labels=c("black", "gray34"),
  fontsize.title=14
  )

################################################################################################################
################################################################################################################

################################################################################################################
################################################################################################################

cc.pval.revigo.names <-  c("term_ID","description","freqInDbPercent","abslog10pvalue","uniqueness","dispensability","representative");
cc.pval.revigo.data <-rbind(c("GO:0005623","cell",64.133,4.0975,0.990,0.000,"cell"),
c("GO:0005856","cytoskeleton",0.714,19.6737,0.584,0.000,"cytoskeleton"),
c("GO:0036449","microtubule minus-end",0.000,4.0386,0.587,0.555,"cytoskeleton"),
c("GO:0005694","chromosome",0.973,6.6925,0.574,0.495,"cytoskeleton"),
c("GO:0044446","intracellular organelle part",5.949,14.1494,0.479,0.640,"cytoskeleton"),
c("GO:0097431","mitotic spindle pole",0.000,2.5171,0.603,0.538,"cytoskeleton"),
c("GO:0043228","non-membrane-bounded organelle",8.439,23.4157,0.611,0.493,"cytoskeleton"),
c("GO:0044430","cytoskeletal part",0.579,17.3107,0.435,0.469,"cytoskeleton"),
c("GO:0044427","chromosomal part",0.450,2.1192,0.548,0.503,"cytoskeleton"),
c("GO:0044428","nuclear part",0.645,15.0752,0.539,0.663,"cytoskeleton"),
c("GO:0043232","intracellular non-membrane-bounded organelle",7.682,23.4157,0.502,0.629,"cytoskeleton"),
c("GO:0043229","intracellular organelle",15.790,15.9872,0.556,0.690,"cytoskeleton"),
c("GO:0044422","organelle part",6.517,14.8386,0.620,0.573,"cytoskeleton"),
c("GO:0030018","Z disc",0.011,3.2218,0.575,0.338,"cytoskeleton"),
c("GO:0005634","nucleus",2.809,15.6126,0.598,0.365,"cytoskeleton"),
c("GO:0031981","nuclear lumen",0.437,17.0565,0.514,0.502,"cytoskeleton"),
c("GO:0043292","contractile fiber",0.030,1.9872,0.663,0.363,"cytoskeleton"),
c("GO:0005911","cell-cell junction",0.091,1.8327,0.881,0.000,"cell-cell junction"),
c("GO:0030054","cell junction",0.154,4.3497,0.972,0.000,"cell junction"),
c("GO:0031974","membrane-enclosed lumen",0.517,12.5143,0.972,0.000,"membrane-enclosed lumen"),
c("GO:0032991","macromolecular complex",14.462,3.4572,0.976,0.000,"macromolecular complex"),
c("GO:0043226","organelle",16.716,12.5272,0.976,0.000,"organelle"),
c("GO:0044456","synapse part",0.066,3.3098,0.928,0.000,"synapse part"),
c("GO:0045202","synapse",0.094,3.9208,0.972,0.000,"synapse"),
c("GO:1902494","catalytic complex",3.772,1.4908,0.889,0.000,"catalytic complex"),
c("GO:0034708","methyltransferase complex",0.032,1.3335,0.836,0.404,"catalytic complex"),
c("GO:0043234","protein complex",8.273,6.0706,0.905,0.573,"catalytic complex"),
c("GO:0030427","site of polarized growth",0.013,3.9031,0.941,0.023,"site of polarized growth"),
c("GO:0030496","midbody",0.014,2.5157,0.941,0.023,"midbody"),
c("GO:0031252","cell leading edge",0.034,1.4711,0.939,0.025,"cell leading edge"),
c("GO:0097458","neuron part",0.092,4.1118,0.936,0.027,"neuron part"),
c("GO:0044463","cell projection part",0.617,3.9788,0.866,0.032,"cell projection part"),
c("GO:0001726","ruffle",0.015,1.9747,0.887,0.597,"cell projection part"),
c("GO:0043005","neuron projection",0.069,3.7496,0.860,0.671,"cell projection part"),
c("GO:0042995","cell projection",1.485,4.7959,0.926,0.035,"cell projection"),
c("GO:0005622","intracellular",46.136,19.0259,0.905,0.064,"intracellular"),
c("GO:0044464","cell part",64.133,4.3072,0.904,0.262,"intracellular"),
c("GO:0005737","cytoplasm",38.159,6.6576,0.810,0.465,"intracellular"),
c("GO:0044424","intracellular part",43.664,16.7721,0.821,0.199,"intracellular"));

cc.pval.stuff <- data.frame(cc.pval.revigo.data);
names(cc.pval.stuff) <- cc.pval.revigo.names;

cc.pval.stuff$abslog10pvalue <- as.numeric( as.character(cc.pval.stuff$abslog10pvalue) );
cc.pval.stuff$freqInDbPercent <- as.numeric( as.character(cc.pval.stuff$freqInDbPercent) );
cc.pval.stuff$uniqueness <- as.numeric( as.character(cc.pval.stuff$uniqueness) );
cc.pval.stuff$dispensability <- as.numeric( as.character(cc.pval.stuff$dispensability) );

# check the tmPlot command documentation for all possible parameters - there are a lot more
treemap(
  cc.pval.stuff,
	index = c("representative","description"),
	vSize = "abslog10pvalue",
	type = "categorical",
	vColor = "representative",
	title = "REVIGO Cellular Component Gene Ontology treemap - pvalue based",
	inflate.labels = FALSE,      # set this to TRUE for space-filling group labels - good for posters
	lowerbound.cex.labels = 0,   # try to draw as many labels as possible (still, some small squares may not get a label)
	bg.labels = "#CCCCCC00",     # define background color of group labels
	# "#CCCCCC00" is fully transparent, "#CCCCCCAA" is semi-transparent grey, NA is opaque
	position.legend = "none",
	border.col=c("black","gray35"),
	palette.HCL.options=list(hue_start=80, hue_perm=TRUE),
	border.lwds=c(5,2),
	fontsize.labels=c(36,12),
	fontcolor.labels=c("black", "gray34"),
  fontsize.title=14
)

################################################################################################################
################################################################################################################

################################################################################################################
################################################################################################################

mf.pval.revigo.names <-  c("term_ID","description","freqInDbPercent","abslog10pvalue","uniqueness","dispensability","representative");
mf.pval.revigo.data <- rbind(c("GO:0003774","motor activity",0.216,4.8601,0.881,0.000,"motor activity"),
c("GO:0016817","hydrolase activity, acting on acid anhydrides",7.557,4.7570,0.893,0.274,"motor activity"),
c("GO:0003777","microtubule motor activity",0.060,3.1831,0.890,0.363,"motor activity"),
c("GO:0017111","nucleoside-triphosphatase activity",7.074,5.5171,0.842,0.548,"motor activity"),
c("GO:0005085","guanyl-nucleotide exchange factor activity",0.061,5.8125,0.970,0.000,"guanyl-nucleotide exchange factor activity"),
c("GO:0005089","Rho guanyl-nucleotide exchange factor activity",0.028,4.2557,0.944,0.000,"Rho guanyl-nucleotide exchange factor activity"),
c("GO:0005096","GTPase activator activity",0.075,5.3595,0.899,0.000,"GTPase activator activity"),
c("GO:0005488","binding",55.585,14.7447,0.987,0.000,"binding"),
c("GO:0005515","protein binding",2.482,20.3799,0.890,0.000,"protein binding"),
c("GO:0018024","histone-lysine N-methyltransferase activity",0.015,4.1537,0.768,0.015,"histone-lysine N-methyltransferase activity"),
c("GO:0008276","protein methyltransferase activity",0.193,3.0560,0.801,0.457,"histone-lysine N-methyltransferase activity"),
c("GO:0016772","transferase activity, transferring phosphorus-containing groups",9.188,1.3028,0.844,0.403,"histone-lysine N-methyltransferase activity"),
c("GO:0016278","lysine N-methyltransferase activity",0.016,3.7721,0.804,0.613,"histone-lysine N-methyltransferase activity"),
c("GO:0008757","S-adenosylmethionine-dependent methyltransferase activity",1.037,2.1261,0.778,0.689,"histone-lysine N-methyltransferase activity"),
c("GO:0016773","phosphotransferase activity, alcohol group as acceptor",4.038,2.3497,0.838,0.517,"histone-lysine N-methyltransferase activity"),
c("GO:0008170","N-methyltransferase activity",0.452,3.0334,0.790,0.589,"histone-lysine N-methyltransferase activity"),
c("GO:0004402","histone acetyltransferase activity",0.010,1.5884,0.899,0.130,"histone-lysine N-methyltransferase activity"),
c("GO:0016741","transferase activity, transferring one-carbon groups",3.193,1.3410,0.856,0.273,"histone-lysine N-methyltransferase activity"),
c("GO:0004674","protein serine/threonine kinase activity",0.565,3.3915,0.860,0.168,"histone-lysine N-methyltransferase activity"),
c("GO:0003682","chromatin binding",0.115,2.9872,0.916,0.050,"chromatin binding"),
c("GO:0008092","cytoskeletal protein binding",0.162,10.3335,0.772,0.052,"cytoskeletal protein binding"),
c("GO:0015631","tubulin binding",0.066,7.8729,0.754,0.524,"cytoskeletal protein binding"),
c("GO:0042393","histone binding",0.016,1.4056,0.800,0.476,"cytoskeletal protein binding"),
c("GO:0032403","protein complex binding",0.146,7.0227,0.773,0.556,"cytoskeletal protein binding"),
c("GO:0019899","enzyme binding",0.221,5.6478,0.767,0.575,"cytoskeletal protein binding"),
c("GO:0017016","Ras GTPase binding",0.029,5.1024,0.757,0.495,"cytoskeletal protein binding"),
c("GO:0008270","zinc ion binding",3.455,4.1035,0.858,0.074,"zinc ion binding"),
c("GO:0003677","DNA binding",13.924,8.3851,0.815,0.184,"zinc ion binding"),
c("GO:0017076","purine nucleotide binding",15.986,7.3936,0.695,0.666,"zinc ion binding"),
c("GO:0003676","nucleic acid binding",21.746,4.8962,0.799,0.317,"zinc ion binding"),
c("GO:0035639","purine ribonucleoside triphosphate binding",15.477,7.0061,0.718,0.686,"zinc ion binding"),
c("GO:1901265","nucleoside phosphate binding",20.353,5.1746,0.802,0.277,"zinc ion binding"),
c("GO:0046914","transition metal ion binding",7.335,2.2076,0.845,0.527,"zinc ion binding"),
c("GO:0097159","organic cyclic compound binding",42.443,8.1733,0.832,0.304,"zinc ion binding"),
c("GO:1901363","heterocyclic compound binding",42.435,8.6421,0.832,0.124,"zinc ion binding"),
c("GO:0097367","carbohydrate derivative binding",16.547,5.0264,0.858,0.196,"zinc ion binding"),
c("GO:0005524","ATP binding",13.885,9.1198,0.654,0.275,"zinc ion binding"),
c("GO:0043168","anion binding",20.956,6.5072,0.826,0.415,"zinc ion binding"),
c("GO:0043167","ion binding",33.309,7.5346,0.840,0.267,"zinc ion binding"),
c("GO:0036094","small molecule binding",21.712,3.2644,0.852,0.219,"zinc ion binding"));

  
mf.pval.stuff <- data.frame(mf.pval.revigo.data);
names(mf.pval.stuff) <- mf.pval.revigo.names;

mf.pval.stuff$abslog10pvalue <- as.numeric( as.character(mf.pval.stuff$abslog10pvalue) );
mf.pval.stuff$freqInDbPercent <- as.numeric( as.character(mf.pval.stuff$freqInDbPercent) );
mf.pval.stuff$uniqueness <- as.numeric( as.character(mf.pval.stuff$uniqueness) );
mf.pval.stuff$dispensability <- as.numeric( as.character(mf.pval.stuff$dispensability) );

# check the tmPlot command documentation for all possible parameters - there are a lot more
treemap(
  mf.pval.stuff,
  index = c("representative","description"),
	vSize = "abslog10pvalue",
	type = "categorical",
	vColor = "representative",
	title = "REVIGO Molecular Function Gene Ontology treemap - pvalue based",
	inflate.labels = FALSE,      # set this to TRUE for space-filling group labels - good for posters
	lowerbound.cex.labels = 0,   # try to draw as many labels as possible (still, some small squares may not get a label)
	bg.labels = "#CCCCCC00",     # define background color of group labels
	# "#CCCCCC00" is fully transparent, "#CCCCCCAA" is semi-transparent grey, NA is opaque
	position.legend = "none",
	border.col=c("black","gray35"),
	palette.HCL.options=list(hue_start=80, hue_perm=TRUE),
	border.lwds=c(5,2),
	fontsize.labels=c(36,12),
	fontcolor.labels=c("black", "gray34"),
  fontsize.title=14
)
```


## Specific GO terms

- are any of the genes from the comparison involved in cell adhesion?
- working from Gene Ontology term for cellular senescence, I pulled down all genes annotated with this [term](http://amigo.geneontology.org/amigo/term/GO:0007155) (and it's "child" terms)
- added specific GO terms as well

```{r GO_annots2}
# pull in probeid to GO term mappings
probeGOmappings <- AnnotationDbi::select(mogene10sttranscriptcluster.db, row.names(all.results[[1]]$stats.eset), "GO", "PROBEID")
# get probes associated with cell adhesion specific GO terms

cellmatrixadhesionGOs <- c("GO:0007160","GO:0016340","GO:0007161","GO:0048041","GO:0051895","GO:0051894","GO:0051893","GO:0001953","GO:0001954","GO:0001952","GO:0061302")

probeGOmappings.celladhesion <- probeGOmappings[which(probeGOmappings$GO %in% c(as.vector(GOBPCHILDREN$"GO:0007155"), "GO:0007155", cellmatrixadhesionGOs)),]

# assign probeids to gene symbols
geneGOmappings.celladhesion <- merge(fData(affyNorm.core)[,c("probesetid", "symbol", "entrezID")], probeGOmappings.celladhesion, by.x="probesetid", by.y="PROBEID", all.y=TRUE)
# aggregate all GO terms for individual genes
geneGOmappings.celladhesion <- aggregate(geneGOmappings.celladhesion$GO,geneGOmappings.celladhesion['symbol'],paste,collapse=',')
names(geneGOmappings.celladhesion) <- c("symbol", "GO")

# get ranks for all genes and add to stat dataframe
ranks <- seq(1:nrow(top.results.Stau2))
top.results.Stau2 <- cbind(ranks, top.results.Stau2)

# merge in cell adhesion specific GO term data
top.results.Stau2 <- merge(top.results.Stau2, geneGOmappings.celladhesion, by="symbol", all.x=TRUE)

write.table(top.results.Stau2[!is.na(top.results.Stau2$GO),], file=file.path(resultsDir, "celladhesion.GO.genes.xls"), sep="\t", row.names=F, col.names=T) 
```

**[Excel file with Cell Adhesion Genes statistics](../results/celladhesion.GO.genes.xls)**


# Kiebler/Kusek Functional analysis

## Kiebler

### Enriched GO terms

- remove any genes with no symbol
- rank by fold change
- take top 200 genes

```{r kiebler, dev='png'}

# pull in kiebler data,run gprofiler, revigo and adhesion checks
kiebler.data <- read.csv(file.path(dataDir, "mmc2.csv")) %>% filter(., Symbol!="---")
top200.kiebler <- subset(kiebler.data, adj.P.Val<pvalue.cutoff & Fold.change>2^lfc.cutoff) %>%  
  filter(., Symbol!="---") %>% 
  arrange(. , desc(Fold.change)) %>% 
  select(., Symbol) %>% 
  as.data.frame() %>% 
  unlist(.) %>% 
  as.vector(.) %>% 
  .[1:200]

gprofiler_results <- gprofiler(query = top200.kiebler, 
                               organism = "rnorvegicus",
                               ordered_query = T, 
                               exclude_iea = F, 
                               max_p_value = 0.05, 
                               max_set_size = 0,
                               correction_method = "gSCS",
                               hier_filtering = "none", 
                               domain_size = "annotated") 

 
gprofiler_results <- tbl_df(gprofiler_results ) %>% mutate(., domain_size=19905) %>% mutate(., enrichment=(overlap.size/query.size)/(term.size/domain_size))
kiebler_go <- gprofiler_results
export(gprofiler_results, file.path(resultsDir, "GOresults.top200.Kiebler.xlsx"))
```

**[Excel file with Kiebler GO enrichments](../results/GOresults.top200.Kiebler.xlsx)**

### Simplify GO terms

```{r, revigokiebler}
bp.pval.revigo.names <- c("term_ID","description","freqInDbPercent","abslog10pvalue","uniqueness","dispensability","representative")
bp.pval.revigo.data <- rbind(c("GO:0002084","protein depalmitoylation",0.000,1.9914,0.430,0.000,"protein depalmitoylation"),
                             c("GO:0098734","macromolecule depalmitoylation",0.002,1.6925,0.430,0.656,"protein depalmitoylation"))

bp.pval.stuff <- data.frame(bp.pval.revigo.data)
names(bp.pval.stuff) <- bp.pval.revigo.names

bp.pval.stuff$abslog10pvalue <- as.numeric( as.character(bp.pval.stuff$abslog10pvalue) )
bp.pval.stuff$freqInDbPercent <- as.numeric( as.character(bp.pval.stuff$freqInDbPercent) )
bp.pval.stuff$uniqueness <- as.numeric( as.character(bp.pval.stuff$uniqueness) )
bp.pval.stuff$dispensability <- as.numeric( as.character(bp.pval.stuff$dispensability) )

# check the tmPlot command documentation for all possible parameters - there are a lot more
treemap(
  bp.pval.stuff,
  index = c("representative","description"),
  vSize = "abslog10pvalue",
  type = "categorical",
  vColor = "representative",
  title = "REVIGO Molecular Function Gene Ontology treemap - pvalue based",
  inflate.labels = FALSE,      # set this to TRUE for space-filling group labels - good for posters
  lowerbound.cex.labels = 0,   # try to draw as many labels as possible (still, some small squares may not get a label)
  bg.labels = "#CCCCCC00",     # define background color of group labels
  # "#CCCCCC00" is fully transparent, "#CCCCCCAA" is semi-transparent grey, NA is opaque
  position.legend = "none",
  border.col=c("black","gray35"),
  palette.HCL.options=list(hue_start=80, hue_perm=TRUE),
  border.lwds=c(5,2),
  fontsize.labels=c(36,12),
  fontcolor.labels=c("black", "gray34"),
  fontsize.title=14
)

##CCs
cc.pval.revigo.names <- c("term_ID","description","freqInDbPercent","abslog10pvalue","uniqueness","dispensability","representative")
cc.pval.revigo.data <- rbind(c("GO:0005623","cell",64.133,1.4547,0.936,0.000,"cell"),
                             c("GO:0031201","SNARE complex",0.004,3.5768,0.748,0.000,"SNARE complex"),
                             c("GO:0043226","organelle",16.716,2.6904,0.854,0.000,"organelle"),
                             c("GO:0043227","membrane-bounded organelle",9.056,4.4828,0.636,0.000,"membrane-bounded organelle"),
                             c("GO:0043231","intracellular membrane-bounded organelle",8.847,3.9914,0.490,0.617,"membrane-bounded organelle"),
                             c("GO:0012505","endomembrane system",0.696,3.4449,0.766,0.021,"endomembrane system"),
                             c("GO:0005737","cytoplasm",38.159,8.8633,0.590,0.083,"cytoplasm"),
                             c("GO:0044464","cell part",64.133,1.5969,0.735,0.262,"cytoplasm"),
                             c("GO:0044444","cytoplasmic part",13.606,6.7447,0.623,0.316,"cytoplasm"),
                             c("GO:0044424","intracellular part",43.664,8.8327,0.601,0.465,"cytoplasm"),
                             c("GO:0005622","intracellular",46.136,9.4976,0.730,0.183,"cytoplasm"))

cc.pval.stuff <- data.frame(cc.pval.revigo.data)
names(cc.pval.stuff) <- cc.pval.revigo.names

cc.pval.stuff$abslog10pvalue <- as.numeric( as.character(cc.pval.stuff$abslog10pvalue) )
cc.pval.stuff$freqInDbPercent <- as.numeric( as.character(cc.pval.stuff$freqInDbPercent) )
cc.pval.stuff$uniqueness <- as.numeric( as.character(cc.pval.stuff$uniqueness) )
cc.pval.stuff$dispensability <- as.numeric( as.character(cc.pval.stuff$dispensability) )

# check the tmPlot command documentation for all possible parameters - there are a lot more
treemap(
  cc.pval.stuff,
  index = c("representative","description"),
  vSize = "abslog10pvalue",
  type = "categorical",
  vColor = "representative",
  title = "REVIGO Molecular Function Gene Ontology treemap - pvalue based",
  inflate.labels = FALSE,      # set this to TRUE for space-filling group labels - good for posters
  lowerbound.cex.labels = 0,   # try to draw as many labels as possible (still, some small squares may not get a label)
  bg.labels = "#CCCCCC00",     # define background color of group labels
  # "#CCCCCC00" is fully transparent, "#CCCCCCAA" is semi-transparent grey, NA is opaque
  position.legend = "none",
  border.col=c("black","gray35"),
  palette.HCL.options=list(hue_start=80, hue_perm=TRUE),
  border.lwds=c(5,2),
  fontsize.labels=c(36,12),
  fontcolor.labels=c("black", "gray34"),
  fontsize.title=14
)


##MFs
mf.pval.revigo.names <- c("term_ID","description","freqInDbPercent","abslog10pvalue","uniqueness","dispensability","representative")
mf.pval.revigo.data <- rbind(c("GO:0005484","SNAP receptor activity",0.008,2.2269,0.766,0.000,"SNAP receptor activity"),
                             c("GO:0008047","enzyme activator activity",0.115,3.1158,0.284,0.000,"enzyme activator activity"),
                             c("GO:0030234","enzyme regulator activity",0.437,1.6091,0.485,0.361,"enzyme activator activity"),
                             c("GO:0008474","palmitoyl-(protein) hydrolase activity",0.002,1.6925,0.742,0.000,"palmitoyl-(protein) hydrolase activity"),
                             c("GO:0098599","palmitoyl hydrolase activity",0.002,1.6925,0.742,0.111,"palmitoyl-(protein) hydrolase activity"),
                             c("GO:0098772","molecular function regulator",8.903,1.4191,0.785,0.000,"molecular function regulator"))

mf.pval.stuff <- data.frame(mf.pval.revigo.data)
names(mf.pval.stuff) <- mf.pval.revigo.names

mf.pval.stuff$abslog10pvalue <- as.numeric( as.character(mf.pval.stuff$abslog10pvalue) )
mf.pval.stuff$freqInDbPercent <- as.numeric( as.character(mf.pval.stuff$freqInDbPercent) )
mf.pval.stuff$uniqueness <- as.numeric( as.character(mf.pval.stuff$uniqueness) )
mf.pval.stuff$dispensability <- as.numeric( as.character(mf.pval.stuff$dispensability) )

# check the tmPlot command documentation for all possible parameters - there are a lot more
treemap(
  mf.pval.stuff,
  index = c("representative","description"),
  vSize = "abslog10pvalue",
  type = "categorical",
  vColor = "representative",
  title = "REVIGO Molecular Function Gene Ontology treemap - pvalue based",
  inflate.labels = FALSE,      # set this to TRUE for space-filling group labels - good for posters
  lowerbound.cex.labels = 0,   # try to draw as many labels as possible (still, some small squares may not get a label)
  bg.labels = "#CCCCCC00",     # define background color of group labels
  # "#CCCCCC00" is fully transparent, "#CCCCCCAA" is semi-transparent grey, NA is opaque
  position.legend = "none",
  border.col=c("black","gray35"),
  palette.HCL.options=list(hue_start=80, hue_perm=TRUE),
  border.lwds=c(5,2),
  fontsize.labels=c(36,12),
  fontcolor.labels=c("black", "gray34"),
  fontsize.title=14
)
```

### Specific GO terms

- are any of the genes from the comparison involved in cell adhesion?
- working from Gene Ontology term for cellular adhesion, I pulled down all genes annotated with this [term](http://amigo.geneontology.org/amigo/term/GO:0007155) (and it's "child" terms)
- added supplied GO terms as well

```{r adhesion_kiebler}
cellmatrixadhesionGOs <- c("GO:0007160","GO:0016340","GO:0007161","GO:0048041","GO:0051895","GO:0051894","GO:0051893","GO:0001953","GO:0001954","GO:0001952","GO:0061302")
cellmatrixadhesionGOs <- c(as.vector(GOBPCHILDREN$"GO:0007155"), "GO:0007155", cellmatrixadhesionGOs)

# get genes associated with GO terms
library(org.Rn.eg.db)
keys <- keys(org.Rn.eg.db)
cols <- c("GO", "SYMBOL")
geneGOmappings <- AnnotationDbi::select(org.Rn.eg.db, keys, cols) %>% tbl_df()
geneGOmappings.celladhesion <- filter(geneGOmappings, GO %in% cellmatrixadhesionGOs) %>% 
  dplyr::select(GO, SYMBOL) %>% 
  group_by(SYMBOL) %>% 
  dplyr::summarise(GO=paste(GO, collapse=","))

kiebler.data <- kiebler.data %>% tbl_df() %>% arrange(., desc(abs(Fold.change))) %>% 
  # get ranks for all genes and add to Kieblers initial data
  mutate(ranks=seq(1:nrow(.))) %>% 
  as.data.frame()

names(geneGOmappings.celladhesion)[1] <- "Symbol"

# merge in cell adhesion specific GO term data
kiebler.data <- left_join(kiebler.data, geneGOmappings.celladhesion, by="Symbol")

export(kiebler.data[!is.na(kiebler.data$GO),], file=file.path(resultsDir, "celladhesion.GO.genes.kiebler.xlsx")) 
```

**[Excel file with Kiebler Cell Adhesion Genes annotations](../results/celladhesion.GO.genes.kiebler.xlsx)**

## Kusek 

### Enriched GO terms

```{r kusek}
# Kusek data
kusek.data <- read.csv(file.path(dataDir, "Kusek_Cell_Stem_Cell_2013.csv"),na.strings = c("", " "), skip=2) %>% 
  tbl_df() %>% 
  mutate(., Symbol=Gene.Symbol, Fold.Change=Fold.change..UP.in.Stau2.vs.Input.) %>% 
  dplyr::select(., -Gene.Symbol, -Fold.change..UP.in.Stau2.vs.Input.) %>% 
  filter(., Symbol!="NA")  

top200.kusek <- filter(kusek.data, Adjusted.p.value<0.05 & Fold.Change>2^lfc.cutoff) %>% 
  arrange(. , desc(Fold.Change)) %>% 
  select(., Symbol) %>% 
  as.data.frame() %>% 
  unlist(.) %>% 
  as.vector(.) %>% 
  .[1:200]

gprofiler_results <- gprofiler(query = top200.kusek, 
                               organism = "mmusculus",
                               ordered_query = T, 
                               exclude_iea = F, 
                               max_p_value = 0.05, 
                               max_set_size = 0,
                               correction_method = "gSCS",
                               hier_filtering = "none", 
                               domain_size = "annotated") 

gprofiler_results <- tbl_df(gprofiler_results ) %>% mutate(., domain_size=22029) %>% mutate(., enrichment=(overlap.size/query.size)/(term.size/domain_size))
export(gprofiler_results, file.path(resultsDir, "GOresults.top200.Kusek.xlsx"))
```

**[Excel file with Kusek GO enrichments](../results/GOresults.top200.Kusek.xlsx)**

### Simplify GO terms

- no need to simplify as there is only one enriched term

### Specific GO terms

- are any of the genes from the comparison involved in cell adhesion?
- working from Gene Ontology term for cellular adhesion, I pulled down all genes annotated with this [term](http://amigo.geneontology.org/amigo/term/GO:0007155) (and it's "child" terms)
- added supplied GO terms as well

```{r adhesion_kusek}
cellmatrixadhesionGOs <- c("GO:0007160","GO:0016340","GO:0007161","GO:0048041","GO:0051895","GO:0051894","GO:0051893","GO:0001953","GO:0001954","GO:0001952","GO:0061302")
cellmatrixadhesionGOs <- c(as.vector(GOBPCHILDREN$"GO:0007155"), "GO:0007155", cellmatrixadhesionGOs)

# get genes associated with GO terms
library(org.Mm.eg.db)
keys <- keys(org.Mm.eg.db)
cols <- c("GO", "SYMBOL")
geneGOmappings <- AnnotationDbi::select(org.Mm.eg.db, keys, cols) %>% tbl_df()
geneGOmappings.celladhesion <- filter(geneGOmappings, GO %in% cellmatrixadhesionGOs) %>% 
  dplyr::select(GO, SYMBOL) %>% 
  group_by(SYMBOL) %>% 
  dplyr::summarise(GO=paste(GO, collapse=","))

kusek.data <- kusek.data %>% arrange(., desc(abs(Fold.Change))) %>% 
  # get ranks for all genes and add to Kieblers initial data
  mutate(ranks=seq(1:nrow(.))) %>% 
  as.data.frame()

names(geneGOmappings.celladhesion)[1] <- "Symbol"


# merge in cell adhesion specific GO term data
kusek.data <- left_join(kusek.data, geneGOmappings.celladhesion, by="Symbol")

export(kusek.data[!is.na(kusek.data$GO),], file=file.path(resultsDir, "celladhesion.GO.genes.kusek.xlsx")) 
```

**[Excel file with Kiebler Cell Adhesion Genes annotations](../results/celladhesion.GO.genes.kusek.xlsx)**

## Kiebler/Kusek DEG overlap functional analysis

### Functional enrichments of DEG overlaps

```{r kieblercompare}
# setup biomarts for pulling in annoation translations
ensemblmart.rat <-  useMart("ensembl",dataset="rnorvegicus_gene_ensembl")
attributes.rat <- listAttributes(ensemblmart.rat)
filters.rat <- listFilters(ensemblmart.rat)
ensemblmart.mus <-  useMart("ensembl",dataset="mmusculus_gene_ensembl")
attributes.mus <- listAttributes(ensemblmart.mus)
filters.mus <- listFilters(ensemblmart.mus)

#  kiebler data, translate rgd symbols to mouse homolog ensembl ids
kiebler.data.sub <- kiebler.data %>% tbl_df() %>% filter(., adj.P.Val<pvalue.cutoff & Fold.change>2^lfc.cutoff)
kiebler.rat.symbols <- kiebler.data.sub$Symbol %>% unique(.) %>% na.omit(.)
kiebler.mus.ensemblids <- as.vector(unlist(getBM(kiebler.rat.symbols, filters="rgd_symbol", attributes="mmusculus_homolog_ensembl_gene", mart=ensemblmart.rat)))


# Kusek data, get mouse ensembl ids
kusek.data.sub <- kusek.data %>% tbl_df() %>% filter(., Adjusted.p.value<pvalue.cutoff & Fold.Change>2^lfc.cutoff)
kusek.mus.symbols <- as.character(unlist(kusek.data.sub$Symbol))
kusek.mus.ensemblids <- as.vector(unlist(getBM(kusek.mus.symbols, filters="mgi_symbol", attributes="ensembl_gene_id", mart=ensemblmart.mus)))

# find mouse ensembl ids of renal pulldown genes
renal.data.sub <- filter(all.results[[1]]$stats.eset, logFC>lfc.cutoff & adj.P.Val<pvalue.cutoff)
renal.mus.ensemblids <- AnnotationDbi::select(mogene10sttranscriptcluster.db, keys = as.character(renal.data.sub$probesetid), columns = "ENSEMBL", keytype = "PROBEID") %>% .$ENSEMBL %>% unique(.) %>% na.omit(.)
num.renal.mus.ensemblids <- length(renal.mus.ensemblids)

#overlaps
kusek.renal.overlap <- intersect(renal.mus.ensemblids, kusek.mus.ensemblids)
kusek.kiebler.overlap <- intersect(kusek.mus.ensemblids, kiebler.mus.ensemblids)
kiebler.renal.overlap <- intersect(kiebler.mus.ensemblids, renal.mus.ensemblids)
```

#### Kiebler-Renal Overlap Functional analysis

##### Gprofiler

```{r kieblerrenalGO}
gprofiler_results  <- gprofiler(query = kiebler.renal.overlap, 
                                organism = "mmusculus",
                                ordered_query = F, 
                                exclude_iea = F, 
                                max_p_value = 0.1, 
                                max_set_size = 0,
                                correction_method = "gSCS",
                                hier_filtering = "none", 
                                domain_size = "annotated") 
export(gprofiler_results, file.path(resultsDir, "GOresults.Kiebler.renal.overlap.xlsx"))
```

**[Excel file with Kiebler-Renal Overlap GO enrichments](../results/GOresults.Kiebler.renal.overlap.xlsx)**

##### Revigo visualization of Gprofiler results
 - only one enriched category, so didn't run Revigo

#### Kusek-Renal Overlap Functional analysis

##### Gprofiler

```{r kusekrenalGO}
gprofiler_results  <- gprofiler(query = kusek.renal.overlap, 
                                organism = "mmusculus",
                                ordered_query = F, 
                                exclude_iea = F, 
                                max_p_value = 0.1, 
                                max_set_size = 0,
                                correction_method = "gSCS",
                                hier_filtering = "none", 
                                domain_size = "annotated") 
export(gprofiler_results, file.path(resultsDir, "GOresults.Kusek.renal.overlap.xlsx"))
```

**[Excel file with Kiebler-Renal Overlap GO enrichments](../results/GOresults.Kusek.renal.overlap.xlsx)**

##### Revigo visualization of Gprofiler results

Once again, there are too few enriched categories to make this worthwhile.

For Biological Processes, there is: regulation of ripoptosome assembly involved in necroptotic process
For Cellular Components, there is: spindle microtubule
For Molecular Functions, there is ATPase activity

#### Kusek-Kiebler Overlap Functional analysis

##### Gprofiler

```{r kieblerkusekGO}
gprofiler_results  <- gprofiler(query = kusek.kiebler.overlap, 
                                organism = "mmusculus",
                                ordered_query = F, 
                                exclude_iea = F, 
                                max_p_value = 0.1, 
                                max_set_size = 0,
                                correction_method = "gSCS",
                                hier_filtering = "none", 
                                domain_size = "annotated") 
export(gprofiler_results, file.path(resultsDir, "GOresults.Kusek.Kiebler.overlap.xlsx"))
```

**[Excel file with Kusek-Kiebler Overlap GO enrichments](../results/GOresults.Kusek.Kiebler.overlap.xlsx)**

```{r kusekkieblerrevigo}
cc.pval.revigo.names <- c("term_ID","description","freqInDbPercent","abslog10pvalue","uniqueness","dispensability","representative");
cc.pval.revigo.data <- rbind(c("GO:0005739","mitochondrion",3.808,4.3143,0.233,0.000,"mitochondrion"),
c("GO:0043227","membrane-bounded organelle",9.056,2.4828,0.404,0.526,"mitochondrion"),
c("GO:0031090","organelle membrane",2.751,2.1904,0.355,0.637,"mitochondrion"),
c("GO:0044444","cytoplasmic part",13.606,3.4486,0.505,0.316,"mitochondrion"),
c("GO:0005737","cytoplasm",38.159,4.7496,0.494,0.221,"mitochondrion"),
c("GO:0044424","intracellular part",43.664,2.0273,0.514,0.465,"mitochondrion"),
c("GO:0005622","intracellular",46.136,2.0565,0.683,0.079,"intracellular"));


cc.pval.stuff <- data.frame(cc.pval.revigo.data);
names(cc.pval.stuff) <- cc.pval.revigo.names;

cc.pval.stuff$abslog10pvalue <- as.numeric( as.character(cc.pval.stuff$abslog10pvalue) );
cc.pval.stuff$freqInDbPercent <- as.numeric( as.character(cc.pval.stuff$freqInDbPercent) );
cc.pval.stuff$uniqueness <- as.numeric( as.character(cc.pval.stuff$uniqueness) );
cc.pval.stuff$dispensability <- as.numeric( as.character(cc.pval.stuff$dispensability) );

treemap(
	cc.pval.stuff,
	index = c("representative","description"),
	vSize = "abslog10pvalue",
	type = "categorical",
	vColor = "representative",
	title = "REVIGO Cellular Component Gene Ontology treemap - pvalue based",
	inflate.labels = FALSE,      # set this to TRUE for space-filling group labels - good for posters
	lowerbound.cex.labels = 0,   # try to draw as many labels as possible (still, some small squares may not get a label)
	bg.labels = "#CCCCCC00",     # define background color of group labels
												       # "#CCCCCC00" is fully transparent, "#CCCCCCAA" is semi-transparent grey, NA is opaque
	position.legend = "none",
  border.col=c("black","gray35"),
  palette.HCL.options=list(hue_start=80, hue_perm=TRUE),
  border.lwds=c(5,2),
  fontsize.labels=c(36,12),
  fontcolor.labels=c("black", "gray34"),
  fontsize.title=14
  )
```


### Overlap of Functional enrichments themselves
- 

```{r GOoverlaps}
# Kusek data
top.kusek <- filter(kusek.data, Adjusted.p.value<pvalue.cutoff & Fold.Change>2^lfc.cutoff) %>% 
  arrange(. , desc(Fold.Change)) %>% 
  select(., Symbol) %>% 
  as.data.frame() %>% 
  unlist(.) %>% 
  as.vector(.)

gprofiler_results.unfiltered <- gprofiler(query = top.kusek, 
                               organism = "mmusculus",
                               ordered_query = T, 
                               exclude_iea = F, 
                               max_p_value = 0.05, 
                               max_set_size = 0,
                               correction_method = "gSCS",
                               hier_filtering = "none", 
                               domain_size = "annotated") 
gprofiler_results.unfiltered <- tbl_df(gprofiler_results.unfiltered ) %>% 
  mutate(., domain_size=22029) %>% 
  mutate(., enrichment=(overlap.size/query.size)/(term.size/domain_size))
kusek_go.unfiltered <- gprofiler_results.unfiltered

top.kiebler <- subset(kiebler.data, adj.P.Val<pvalue.cutoff & Fold.change>2^lfc.cutoff) %>%  
  filter(., Symbol!="---") %>% 
  arrange(. , desc(Fold.change)) %>% 
  select(., Symbol) %>% 
  as.data.frame() %>% 
  unlist(.) %>% 
  as.vector(.) 

gprofiler_results.unfiltered <- gprofiler(query = top.kiebler, 
                               organism = "rnorvegicus",
                               ordered_query = T, 
                               exclude_iea = F, 
                               max_p_value = 0.05, 
                               max_set_size = 0,
                               correction_method = "gSCS",
                               hier_filtering = "none", 
                               domain_size = "annotated") 
gprofiler_results.unfiltered <- tbl_df(gprofiler_results.unfiltered ) %>% 
  mutate(., domain_size=19905) %>% 
  mutate(., enrichment=(overlap.size/query.size)/(term.size/domain_size))
kiebler_go.unfiltered <- gprofiler_results.unfiltered

gprofiler_results.unfiltered  <- gprofiler(query = top.Stau2, 
                                           organism = "mmusculus",
                                           ordered_query = T, 
                                           exclude_iea = F, 
                                           max_p_value = 0.05, 
                                           max_set_size = 0,
                                           correction_method = "gSCS",
                                           hier_filtering = "none", 
                                           domain_size = "annotated") 
gprofiler_results.unfiltered <- tbl_df(gprofiler_results.unfiltered ) %>% 
  mutate(., domain_size=22029) %>% 
  mutate(., enrichment=(overlap.size/query.size)/(term.size/domain_size))
renal_go.unfiltered <- gprofiler_results.unfiltered

### From GO terms
kusek_go.sub <- filter(kusek_go.unfiltered, domain=="CC" | domain=="MF" | domain=="BP") %>% dplyr::select(., term.id, term.name, domain,p.value, enrichment, intersection) %>%  mutate(., set="Kusek")
kiebler_go.sub <- filter(kiebler_go.unfiltered, domain=="CC" | domain=="MF" | domain=="BP") %>% dplyr::select(., term.id, term.name, domain,p.value, enrichment, intersection) %>% mutate(., set="Kiebler")
renal_go.sub <- filter(renal_go.unfiltered, domain=="CC" | domain=="MF" | domain=="BP") %>% dplyr::select(., term.id, term.name,domain, p.value, enrichment, intersection)%>% mutate(., set="Renal")
all_go.sub <- rbind(kusek_go.sub, kiebler_go.sub, renal_go.sub)  %>% mutate(log10pvalue=-log10(p.value)) %>% arrange(domain)
bp_go.sub <- all_go.sub %>% filter(domain=="BP") %>% filter (p.value<0.01) %>% filter(enrichment>2.5)
mf_go.sub <- all_go.sub %>% filter(domain=="MF") %>% filter(p.value<0.01) %>%  filter(enrichment>2.5)
cc_go.sub <- all_go.sub %>% filter(domain=="CC") %>% filter(p.value<0.01) %>%  filter(enrichment>2.5)

library(GOSemSim)
# calculaute all pairwise GO semantic similarities and use to for distance matrix for dendrogram
all_gos <- dplyr::select(all_go.sub, term.id, domain) %>% arrange(term.id) %>% distinct() %>% arrange(domain) %>% dplyr::select( term.id) %>% as.data.frame %>% unlist %>% as.vector
bp_gos <-  dplyr::select(bp_go.sub, term.id, domain) %>%  filter(domain=="BP") %>% arrange(term.id) %>% distinct() %>% arrange(domain) %>% dplyr::select( term.id) %>% as.data.frame %>% unlist %>% as.vector
mf_gos <- dplyr::select(mf_go.sub, term.id, domain) %>%  filter(domain=="MF")%>% arrange(term.id) %>% distinct() %>% arrange(domain) %>% dplyr::select( term.id) %>% as.data.frame %>% unlist %>% as.vector
cc_gos <- dplyr::select(cc_go.sub, term.id, domain) %>%  filter(domain=="CC")%>% arrange(term.id) %>% distinct() %>% arrange(domain) %>% dplyr::select( term.id) %>% as.data.frame %>% unlist %>% as.vector
# all pairwise comparisons
bp.comparisons <- expand.grid(term1=bp_gos, term2=bp_gos)
mf.comparisons <- expand.grid(term1=mf_gos, term2=mf_gos)
cc.comparisons <- expand.grid(term1=cc_gos, term2=cc_gos)
# calculate pairwise semantic similarities adn put into matrix
method <- "Wang"
bp.sem.matrix <- ddply(bp.comparisons,1, function(x) goSim(x[1], x[2], organism="mouse", ont="BP", measure=method))
mf.sem.matrix <- ddply(mf.comparisons,1, function(x) goSim(x[1], x[2], organism="mouse", ont="MF", measure=method))
cc.sem.matrix <- ddply(cc.comparisons,1, function(x) goSim(x[1], x[2], organism="mouse", ont="CC", measure=method))

# label matrices
bp.sem.matrix <- col2rownames(bp.sem.matrix, "term1")
mf.sem.matrix <- col2rownames(mf.sem.matrix, "term1")
cc.sem.matrix <- col2rownames(cc.sem.matrix, "term1")
names(bp.sem.matrix) <- row.names(bp.sem.matrix)
names(mf.sem.matrix) <- row.names(mf.sem.matrix)
names(cc.sem.matrix) <- row.names(cc.sem.matrix)

# cleanup missing values
bp.sem.matrix[is.na(bp.sem.matrix)]<- 0
mf.sem.matrix[is.na(mf.sem.matrix)]<- 0
cc.sem.matrix[is.na(cc.sem.matrix)]<- 0

# invert scale so dendrogram is also inverted
bp.sem.matrix <- 1-bp.sem.matrix
mf.sem.matrix <- 1-mf.sem.matrix
cc.sem.matrix <- 1-cc.sem.matrix

# get clustering based on semantic similariites
bp.hc <- hclust(as.dist(as.matrix(bp.sem.matrix)))
mf.hc <- hclust(as.dist(as.matrix(mf.sem.matrix)))
cc.hc <- hclust(as.dist(as.matrix(cc.sem.matrix)))

# get ordering of terms from clustering adn make new dataframe for plot
bp.GO.term.ids.ordered <- names(bp.sem.matrix)[bp.hc$order]
bp.GO.term.names.ordered <-bp_go.sub$term.name[match(bp.GO.term.ids.ordered, bp_go.sub$term.id)]
bp_go.sub <- bp_go.sub %>% as.data.frame()
bp_go.sub$term.id <- factor(bp_go.sub$term.id, levels=bp.GO.term.ids.ordered)
bp_go.sub$term.name <- factor(bp_go.sub$term.name, levels=bp.GO.term.names.ordered)

mf.GO.term.ids.ordered <- names(mf.sem.matrix)[mf.hc$order]
mf.GO.term.names.ordered <-mf_go.sub$term.name[match(mf.GO.term.ids.ordered, mf_go.sub$term.id)]
mf_go.sub <- mf_go.sub %>% as.data.frame()
mf_go.sub$term.id <- factor(mf_go.sub$term.id, levels=mf.GO.term.ids.ordered)
mf_go.sub$term.name <- factor(mf_go.sub$term.name, levels=mf.GO.term.names.ordered)

cc.GO.term.ids.ordered <- names(cc.sem.matrix)[cc.hc$order]
cc.GO.term.names.ordered <-cc_go.sub$term.name[match(cc.GO.term.ids.ordered, cc_go.sub$term.id)]
cc_go.sub <- cc_go.sub %>% as.data.frame()
cc_go.sub$term.id <- factor(cc_go.sub$term.id, levels=cc.GO.term.ids.ordered)
cc_go.sub$term.name <- factor(cc_go.sub$term.name, levels=cc.GO.term.names.ordered)

require(dendextend)
colors <- brewer.pal(n = 10, name="Paired")
heightcutoff=0.5

dend.bp.hc <- bp.hc %>% 
  as.dendrogram %>%
  color_branches(., h=heightcutoff, col=colors) %>% 
  set("branches_lwd", 1) %>%
  set("labels_cex", 0.6) %>% 
  set("labels_colors", h=heightcutoff, value=colors) %>% 
  set("leaves_pch", 19) %>% 
  set("leaves_cex", 0.5) 
ggd1 <- as.ggdend(dend.bp.hc)
bp.d <- ggplot(ggd1, horiz = TRUE)

dend.mf.hc <- mf.hc %>% 
  as.dendrogram %>%
  color_branches(., h=heightcutoff, col=colors) %>% 
  set("branches_lwd", 1) %>%
  set("labels_cex", 0.6) %>% 
  set("labels_colors", h=heightcutoff, value=colors) %>% 
  set("leaves_pch", 19) %>% 
  set("leaves_cex", 0.5) 
ggd1 <- as.ggdend(dend.mf.hc)
mf.d <- ggplot(ggd1, horiz = TRUE)

dend.cc.hc <- cc.hc %>% 
  as.dendrogram %>%
  color_branches(., h=heightcutoff, col=colors) %>% 
  set("branches_lwd", 1) %>%
  set("labels_cex", 0.6) %>% 
  set("labels_colors", h=heightcutoff, value=colors) %>% 
  set("leaves_pch", 19) %>% 
  set("leaves_cex", 0.5) 
ggd1 <- as.ggdend(dend.cc.hc)
cc.d <- ggplot(ggd1, horiz = TRUE)

bp.dp <- ggplot(bp_go.sub,aes(x=set, y=term.name, size=enrichment, color=log10pvalue))+  
  geom_point() + 
  scale_color_gradient(low="blue", high="red") +
   theme_bw()+
    theme(legend.position="left")+
  theme(panel.grid.major.x = element_blank(), panel.grid.major.y = element_line( size=.1, color="black" ))+
  ggtitle("Significant Enrichments of Biological Process GO Terms")+ 
  scale_y_discrete(position = "right") + theme(legend.position="right")

mf.dp <- ggplot(mf_go.sub,aes(x=set, y=term.name, size=enrichment, color=log10pvalue))+  
  geom_point() + 
  scale_color_gradient(low="blue", high="red") +
   theme_bw()+
    theme(legend.position="left")+
  theme(panel.grid.major.x = element_blank(), panel.grid.major.y = element_line( size=.1, color="black" ))+
  ggtitle("Significant Enrichments of Molecular Function GO Terms")+ 
  scale_y_discrete(position = "right") + theme(legend.position="right")

cc.dp <- ggplot(cc_go.sub,aes(x=set, y=term.name, size=enrichment, color=log10pvalue))+  
  geom_point() + 
  scale_color_gradient(low="blue", high="red") +
   theme_bw()+
    theme(legend.position="left")+
  theme(panel.grid.major.x = element_blank(), panel.grid.major.y = element_line( size=.1, color="black" ))+
  ggtitle("Significant Enrichments of Cellular Component GO Terms")+ 
  scale_y_discrete(position = "right") + theme(legend.position="right")
 
library(gridExtra)

grid.arrange(bp.d,bp.dp,ncol=2)
grid.arrange(mf.d, mf.dp,ncol=2)
grid.arrange(cc.d, cc.dp,ncol=2)

### Table with results
kusek_go.sub <- kusek_go.unfiltered %>% filter(domain=="BP"|domain=="MF"|domain=="CC") %>% dplyr::select(term.id, term.name, domain, p.value, enrichment, intersection)
renal_go.sub <- renal_go.unfiltered %>% filter(domain=="BP"|domain=="MF"|domain=="CC") %>%  dplyr::select(term.id, term.name, domain, p.value, enrichment, intersection)
kiebler_go.sub <- kiebler_go.unfiltered %>% filter(domain=="BP"|domain=="MF"|domain=="CC") %>%  dplyr::select(term.id, term.name, domain, p.value, enrichment, intersection)

renal.kiebler.go.stats <- merge(renal_go.sub, kiebler_go.sub, by=c("term.id", "term.name","domain"), all=TRUE, suffixes=c(".Renal", ".Kiebler"))
renal.kiebler.kusek.go.stats <- merge(renal.kiebler.go.stats, kusek_go.sub, by=c("term.id", "term.name", "domain"), all=TRUE, suffixes=c("", ".Kuskek"))
names(renal.kiebler.kusek.go.stats) <- sub("^p.value$", "p.value.Kusek", names(renal.kiebler.kusek.go.stats))
names(renal.kiebler.kusek.go.stats) <- sub("^enrichment$", "enrichment.Kusek", names(renal.kiebler.kusek.go.stats))
names(renal.kiebler.kusek.go.stats) <- sub("^intersection$", "intersection.Kusek", names(renal.kiebler.kusek.go.stats))
export(renal.kiebler.kusek.go.stats, file.path(resultsDir, "renal.kiebler.kusek.go.stats.xlsx"))
```


```{r intensity_distributions}
library(janitor)
input_intensities <- clean_names(all.results[[1]]$stats.eset) %>% tbl_df %>% dplyr::select(symbol, contains("input"), -contains("mrna"))

#  kiebler data, translate rgd symbols to mouse symbols
kiebler.data.sub <- kiebler.data %>% tbl_df() %>% filter(., adj.P.Val<pvalue.cutoff & Fold.change>2^lfc.cutoff)
kiebler.rat.symbols <- kiebler.data.sub$Symbol %>% unique(.) %>% na.omit(.)
kiebler.mus.ensemblids <- as.vector(unlist(getBM(kiebler.rat.symbols, filters="rgd_symbol", attributes="mmusculus_homolog_ensembl_gene", mart=ensemblmart.rat)))
kiebler.mus.symbols <- as.vector(unlist(getBM(kiebler.mus.ensemblids, filters="ensembl_gene_id", attributes="mgi_symbol", mart=ensemblmart.mus)))
top.kiebler <- kiebler.mus.symbols

top.Stau2.diff <-setdiff(setdiff(top.Stau2, kiebler.mus.symbols), kusek.mus.symbols)

input_intensities <- mutate(input_intensities, renal=ifelse(symbol %in% top.Stau2.diff,"1", "0"), kusek=ifelse(symbol %in% top.kusek, "1", "0"),kiebler=ifelse(symbol %in% top.kiebler, "1", "0"), all=ifelse(symbol %in% symbol, "1", "0")) %>% mutate(mean=rowMeans(dplyr::select(.,contains("input")))) %>% dplyr::select(., -contains("input"))

library(tidyr)
input_intensities <- tidyr::gather(temp, set, include, renal, kiebler, kusek, all, -symbol, -mean) %>% filter(., include==1) %>% dplyr::select(-include)

ggplot(input_intensities, aes(color=set, x=mean))+geom_density()+xlab("Mean intensity in input samples")


  
```

----

# R Session Info

(useful if replicating these results)

```{r sessioninfo}
sessionInfo()
```

---

# References

```{r writebib, results='hide', echo=FALSE, message=FALSE}
write.bibtex(file="references.bib")
```

